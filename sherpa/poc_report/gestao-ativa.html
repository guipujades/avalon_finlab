<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Carteira Avalon - Gestão Ativa Estratégica</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>
    <style>
        #runMaintenanceAnalysis {
            background: linear-gradient(to right, #ea580c, #c2410c) !important;
            color: white !important;
            border: none !important;
        }
        #runMaintenanceAnalysis:hover {
            background: linear-gradient(to right, #c2410c, #9a3412) !important;
            transform: translateY(-2px) !important;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15) !important;
        }
        #runMaintenanceAnalysis:disabled {
            opacity: 0.5 !important;
            cursor: not-allowed !important;
        }
        
        /* Garantir que os ícones SVG sejam visíveis */
        .etf-card svg {
            display: block !important;
            opacity: 1 !important;
            visibility: visible !important;
        }
        
        /* Animação sutil para as barras de progresso */
        .etf-card .bg-orange-600,
        .etf-card .bg-amber-600,
        .etf-card .bg-yellow-600 {
            animation: progressLoad 1.5s ease-out;
        }
        
        @keyframes progressLoad {
            from { width: 0%; }
            to { width: var(--progress-width); }
        }
    </style>
</head>
<body class="bg-gray-50">
    <header class="bg-gray-900 text-white shadow-lg">
        <div class="container mx-auto py-6 px-4">
            <h1 class="text-3xl font-bold">Carteira Avalon - Gestão Ativa Estratégica</h1>
            <div class="mt-2">
                <a href="offshore.html" class="text-gray-400 hover:text-white transition-colors duration-300">
                    ← Voltar à Visão Geral
                </a>
            </div>
            <p class="mt-2 opacity-80">Estratégia de preservação de capital com diversificação funcional</p>
        </div>
    </header>
    
    <!-- Botão Operacional -->
    <div class="container mx-auto px-4">
        <div class="transform -translate-y-1/4 flex justify-end">
            <button onclick="openModal('operacionalModal')" 
               class="group inline-flex items-center px-6 py-3 
                      bg-black text-white rounded-lg 
                      hover:bg-gray-800 transition-all duration-300 
                      border border-gray-700 hover:border-gray-600
                      shadow-lg hover:shadow-xl
                      backdrop-filter backdrop-blur-sm">
                <svg class="w-5 h-5 mr-3 text-gray-400 group-hover:text-white transition-colors duration-300" 
                     fill="none" 
                     stroke="currentColor" 
                     viewBox="0 0 24 24">
                    <path stroke-linecap="round" 
                          stroke-linejoin="round" 
                          stroke-width="1.5" 
                          d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"/>
                </svg>
                <span class="font-medium tracking-wide">Operacional</span>
                <svg class="w-4 h-4 ml-3 opacity-0 group-hover:opacity-100 transform translate-x-0 group-hover:translate-x-1 transition-all duration-300" 
                     fill="none" 
                     stroke="currentColor" 
                     viewBox="0 0 24 24">
                    <path stroke-linecap="round" 
                          stroke-linejoin="round" 
                          stroke-width="1.5" 
                          d="M9 5l7 7-7 7"/>
                </svg>
            </button>
        </div>
    </div>

    <!-- Premissas Macro para Alocação -->
    <section class="container mx-auto px-4 py-6">
        <div class="bg-gradient-to-r from-gray-50 to-blue-50 p-6 rounded-lg mb-4 border-l-4 border-black">
            <h3 class="text-xl font-bold text-gray-800 mb-4">Premissas Macro para Alocação</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                            <!-- Estados Unidos -->
                            <div class="bg-white p-5 rounded-lg shadow-sm border border-gray-200">
                    <div class="mb-3">
                                    <h4 class="font-semibold text-gray-800">Estados Unidos</h4>
                                </div>
                                <ul class="text-sm text-gray-600 space-y-2">
                                    <li class="flex items-start">
                                        <span class="text-blue-500 mr-2">•</span>
                                        <span>Juros nominais elevados por mais tempo devido a mudanças estruturais pós-COVID</span>
                                    </li>
                                    <li class="flex items-start">
                                        <span class="text-blue-500 mr-2">•</span>
                                        <span>Inflação persistente com pressões salariais e fiscais recorrentes</span>
                                    </li>
                                    <li class="flex items-start">
                                        <span class="text-blue-500 mr-2">•</span>
                                        <span>Ambiente político polarizado e deterioração fiscal ampliando riscos</span>
                                    </li>
                                </ul>
                            </div>

                            <!-- Cenário Global -->
                            <div class="bg-white p-5 rounded-lg shadow-sm border border-gray-200">
                    <div class="mb-3">
                                    <h4 class="font-semibold text-gray-800">Cenário Global</h4>
                                </div>
                                <ul class="text-sm text-gray-600 space-y-2">
                                    <li class="flex items-start">
                                        <span class="text-green-500 mr-2">•</span>
                                        <span>Fragmentação geopolítica aumenta riscos de choques de oferta</span>
                                    </li>
                                    <li class="flex items-start">
                                        <span class="text-green-500 mr-2">•</span>
                                        <span>Reprecificação das moedas fortalece o ouro como reserva de valor</span>
                                    </li>
                                    <li class="flex items-start">
                                        <span class="text-green-500 mr-2">•</span>
                                        <span>Volatilidade amplificada por ciclos monetários desalinhados</span>
                                    </li>
                                </ul>
                            </div>
                        </div>
                            </div>
    </section>

    <div class="container mx-auto px-4 py-8">
        <!-- Composição Detalhada -->
        <div class="bg-white rounded-lg shadow p-6 mb-8">
            <h2 class="text-2xl font-bold mb-6">Composição Estratégica da Carteira</h2>

            <!-- Camada de Preservação -->
            <div class="bg-blue-50 p-6 rounded-lg mb-8 border border-blue-200">
                <h3 class="text-xl font-bold mb-4 text-blue-800">Camada de Preservação (20% da carteira total)</h3>
                <p class="text-sm text-blue-700 mb-6">Proteção do capital nominal em dólares com liquidez e segurança</p>
            
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <!-- Gráfico de alocação da preservação -->
                    <div class="bg-white p-6 rounded-lg shadow-sm">
                        <h4 class="text-lg font-semibold mb-4 text-center">Distribuição da Camada</h4>
                        <div class="w-full" style="height: 400px;">
                            <canvas id="preservationChart"></canvas>
                    </div>
                </div>

                    <!-- Detalhamento da preservação -->
                    <div class="space-y-4">
                        <div class="bg-white p-4 rounded-lg shadow-sm border-l-4 border-blue-900">
                            <div class="flex justify-between items-center">
                                <div>
                                    <h5 class="font-semibold text-gray-800">U03A - T-Bills 0-3 meses</h5>
                                    <p class="text-sm text-gray-600">Liquidez imediata</p>
                                </div>
                                <span class="text-lg font-bold text-blue-900">60%</span>
                            </div>
                        </div>
                        
                        <div class="bg-white p-4 rounded-lg shadow-sm border-l-4 border-blue-800">
                            <div class="flex justify-between items-center">
                                <div>
                                    <h5 class="font-semibold text-gray-800">IBTA - Treasuries 1-3 anos</h5>
                                    <p class="text-sm text-gray-600">Núcleo defensivo estável</p>
                                </div>
                                <span class="text-lg font-bold text-blue-800">20%</span>
                            </div>
                        </div>
                        
                        <div class="bg-white p-4 rounded-lg shadow-sm border-l-4 border-blue-700">
                            <div class="flex justify-between items-center">
                                <div>
                                    <h5 class="font-semibold text-gray-800">TFRN - Floating Rate Notes</h5>
                                    <p class="text-sm text-gray-600">Proteção "higher-for-longer"</p>
                                </div>
                                <span class="text-lg font-bold text-blue-700">20%</span>
                            </div>
                        </div>
                                </div>
                            </div>

                <!-- Análise Detalhada dos ETFs -->
                <div class="mt-8">
                    <div class="bg-gradient-to-r from-blue-50 via-indigo-50 to-purple-50 rounded-xl p-8 border border-blue-200 shadow-lg">
                        <div class="text-center mb-8">
                            <h4 class="text-2xl font-bold text-gray-800 mb-3">Análise dos produtos selecionados</h4>
                        </div>

                        <!-- Cards dos ETFs -->
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <!-- Card U03A -->
                            <div class="etf-card bg-white rounded-xl p-6 shadow-md hover:shadow-xl transition-all duration-300 border border-gray-100 cursor-pointer" data-etf="u03a">
                                <div class="mb-4">
                                        <h5 class="font-bold text-gray-800">U03A</h5>
                                        <p class="text-sm text-gray-600">T-Bills 0-3M</p>
                        </div>

                                <div class="space-y-3">
                            <div class="flex justify-between items-center">
                                        <span class="text-sm text-gray-600">TER</span>
                                        <span class="font-semibold text-blue-600">0,07%</span>
                                </div>
                                    <div class="flex justify-between items-center">
                                        <span class="text-sm text-gray-600">AUM</span>
                                        <span class="font-semibold text-blue-600">$1,2B</span>
                                    </div>
                                    <div class="flex justify-between items-center">
                                        <span class="text-sm text-gray-600">Duration</span>
                                        <span class="font-semibold text-blue-600">0,08</span>
                            </div>
                        </div>

                                <div class="mt-4 pt-4 border-t border-gray-100">
                                    <p class="text-xs text-gray-500 mb-2">Papel na Carteira:</p>
                                    <p class="text-sm text-gray-700">Liquidez imediata e proteção de capital com yield próximo ao Fed Funds Rate.</p>
                                </div>

                                <div class="mt-4">
                                    <div class="w-full bg-blue-100 rounded-full h-2">
                                        <div class="bg-blue-600 h-2 rounded-full" style="width: 60%"></div>
                            </div>
                                    <p class="text-xs text-gray-500 mt-1">60% da camada de preservação</p>
                        </div>
                            </div>

                            <!-- Card IBTA.L -->
                            <div class="etf-card bg-white rounded-xl p-6 shadow-md hover:shadow-xl transition-all duration-300 border border-gray-100 cursor-pointer" data-etf="ibta">
                                <div class="mb-4">
                                        <h5 class="font-bold text-gray-800">IBTA</h5>
                                        <p class="text-sm text-gray-600">Treasury 1-3Y</p>
                </div>

                            <div class="space-y-3">
                                <div class="flex justify-between items-center">
                                        <span class="text-sm text-gray-600">TER</span>
                                        <span class="font-semibold text-indigo-600">0,07%</span>
                                </div>
                                <div class="flex justify-between items-center">
                                        <span class="text-sm text-gray-600">AUM</span>
                                        <span class="font-semibold text-indigo-600">$12,3B</span>
                                </div>
                                <div class="flex justify-between items-center">
                                        <span class="text-sm text-gray-600">Duration</span>
                                        <span class="font-semibold text-indigo-600">1,9</span>
                                </div>
                                </div>

                                <div class="mt-4 pt-4 border-t border-gray-100">
                                    <p class="text-xs text-gray-500 mb-2">Papel na Carteira:</p>
                                    <p class="text-sm text-gray-700">Núcleo defensivo estável com benefícios fiscais UCITS e correlação negativa com risk assets.</p>
                            </div>
                            
                                <div class="mt-4">
                                    <div class="w-full bg-indigo-100 rounded-full h-2">
                                        <div class="bg-indigo-600 h-2 rounded-full" style="width: 20%"></div>
                                    </div>
                                    <p class="text-xs text-gray-500 mt-1">20% da camada de preservação</p>
                            </div>
                        </div>

                            <!-- Card TFRN.L -->
                            <div class="etf-card bg-white rounded-xl p-6 shadow-md hover:shadow-xl transition-all duration-300 border border-gray-100 cursor-pointer" data-etf="tfrn">
                                <div class="mb-4">
                                        <h5 class="font-bold text-gray-800">TFRN</h5>
                                        <p class="text-sm text-gray-600">Floating Rate</p>
                                </div>
                                
                                <div class="space-y-3">
                                    <div class="flex justify-between items-center">
                                        <span class="text-sm text-gray-600">TER</span>
                                        <span class="font-semibold text-purple-600">0,15%</span>
                                </div>
                                    <div class="flex justify-between items-center">
                                        <span class="text-sm text-gray-600">AUM</span>
                                        <span class="font-semibold text-purple-600">$300M</span>
                            </div>
                                    <div class="flex justify-between items-center">
                                        <span class="text-sm text-gray-600">Duration</span>
                                        <span class="font-semibold text-purple-600">0,1</span>
                        </div>
                    </div>

                                <div class="mt-4 pt-4 border-t border-gray-100">
                                    <p class="text-xs text-gray-500 mb-2">Papel na Carteira:</p>
                                    <p class="text-sm text-gray-700">Proteção "higher-for-longer" com yield que acompanha Fed Funds e hedge contra alta de juros.</p>
                            </div>

                                <div class="mt-4">
                                    <div class="w-full bg-purple-100 rounded-full h-2">
                                        <div class="bg-purple-600 h-2 rounded-full" style="width: 20%"></div>
                                    </div>
                                    <p class="text-xs text-gray-500 mt-1">20% da camada de preservação</p>
                        </div>
                    </div>
            </div>
        </div>

                    <!-- Botão para Análise Avançada -->
                <div class="text-center mt-6">
                        <button id="runStressTest" class="group inline-flex items-center px-6 py-3 bg-gradient-to-r from-blue-600 to-blue-700 text-white rounded-lg hover:from-blue-700 hover:to-blue-800 transition-all duration-300 shadow-lg hover:shadow-xl transform hover:-translate-y-1">
                            <svg class="w-4 h-4 mr-2 text-blue-200 group-hover:text-white transition-colors duration-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                            </svg>
                            <span class="font-medium">Análise Detalhada</span>
                            <svg class="w-4 h-4 ml-2 opacity-0 group-hover:opacity-100 transform translate-x-0 group-hover:translate-x-1 transition-all duration-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6"></path>
                            </svg>
                        </button>
            </div>

                    <!-- Loading e Results -->
                    <div id="pythonLoading" class="hidden mt-6 text-center">
                        <div class="inline-flex items-center px-4 py-2 border border-blue-300 rounded-full bg-blue-50">
                            <svg class="animate-spin -ml-1 mr-3 h-4 w-4 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                            <span class="text-blue-700 font-medium text-sm">Processando análise de preservação...</span>
            </div>
        </div>

                    <div id="pythonResults" class="hidden mt-6">
                        <div class="bg-gradient-to-r from-blue-50 to-slate-50 p-6 rounded-lg border border-blue-200">
                            <h5 class="text-lg font-bold mb-4 text-blue-800">Resultados da Análise Quantitativa</h5>
                            <div id="stressTestOutput" class="space-y-4">
                                <!-- Os resultados aparecerão aqui -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Camada de Manutenção -->
            <div class="bg-orange-50 p-6 rounded-lg mb-8 border border-orange-200">
                <h3 class="text-xl font-bold mb-4 text-orange-800">Camada de Manutenção (55% da carteira total)</h3>
                <p class="text-sm text-orange-700 mb-6">Estratégia de crédito com proteção - Meta ~6-7% a.a.</p>
                
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <!-- Gráfico da Manutenção -->
                    <div class="bg-white p-6 rounded-lg shadow-sm">
                        <h4 class="text-lg font-semibold mb-4 text-center text-orange-800">Composição da Manutenção</h4>
                        <div class="w-full" style="height: 400px;">
                            <canvas id="maintenanceChart"></canvas>
                        </div>
                    </div>

                    <!-- Detalhamento da manutenção -->
            <div class="space-y-4">
                        <div class="bg-white p-4 rounded-lg shadow-sm border-l-4 border-orange-800">
                            <div class="flex justify-between items-center">
                                <div>
                                    <h5 class="font-semibold text-gray-800">PIMCO Income</h5>
                                    <p class="text-sm text-gray-600">Núcleo de crédito multi-setor</p>
                                </div>
                                <span class="text-lg font-bold text-orange-800">60%</span>
                        </div>
                        </div>

                        <div class="bg-white p-4 rounded-lg shadow-sm border-l-4 border-orange-600">
                            <div class="flex justify-between items-center">
                                <div>
                                    <h5 class="font-semibold text-gray-800">TIP5 - TIPS 0-5Y</h5>
                                    <p class="text-sm text-gray-600">Proteção contra inflação</p>
                                </div>
                                <span class="text-lg font-bold text-orange-600">20%</span>
                            </div>
                        </div>

                        <div class="bg-white p-4 rounded-lg shadow-sm border-l-4 border-orange-400">
                            <div class="flex justify-between items-center">
                                <div>
                                    <h5 class="font-semibold text-gray-800">SGLN - Ouro</h5>
                                    <p class="text-sm text-gray-600">Proteção e descorrelação</p>
                                </div>
                                <span class="text-lg font-bold text-orange-400">20%</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Análise dos Produtos -->
                <div class="mt-8">
                    <div class="bg-gradient-to-r from-orange-50 via-amber-50 to-yellow-50 rounded-xl p-8 border border-orange-200 shadow-lg">
                        <div class="text-center mb-8">
                            <h4 class="text-2xl font-bold text-gray-800 mb-3">Análise dos produtos selecionados</h4>
                        </div>

                        <!-- Cards dos Produtos -->
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <!-- Card PIMCO Income -->
                            <div class="etf-card bg-white rounded-xl p-6 shadow-md hover:shadow-xl transition-all duration-300 border border-gray-100 cursor-pointer" data-etf="pimco-income">
                                <div class="mb-4">
                                    <h5 class="font-bold text-gray-800">PIMCO Income</h5>
                                    <p class="text-sm text-gray-600">Multi-Setor Global</p>
                                </div>
                                
                                <div class="space-y-3">
                                    <div class="flex justify-between items-center">
                                        <span class="text-sm text-gray-600">TER</span>
                                        <span class="font-semibold text-orange-600">0.55%</span>
                                    </div>
                                    <div class="flex justify-between items-center">
                                        <span class="text-sm text-gray-600">AUM</span>
                                        <span class="font-semibold text-orange-600">$130B</span>
                                    </div>
                                    <div class="flex justify-between items-center">
                                        <span class="text-sm text-gray-600">Yield</span>
                                        <span class="font-semibold text-orange-600">5.8%</span>
                                    </div>
                                </div>

                                <div class="mt-4 pt-4 border-t border-gray-100">
                                    <p class="text-xs text-gray-500 mb-2">Papel na Carteira:</p>
                                    <p class="text-sm text-gray-700">Exposição diversificada a crédito global com gestão ativa e foco em geração de renda.</p>
                                </div>

                                <div class="mt-4">
                                    <div class="w-full bg-orange-100 rounded-full h-3 mb-2" style="background-color: #fed7aa;">
                                        <div class="h-3 rounded-full" style="width: 60%; background-color: #ea580c; transition: all 0.3s ease;"></div>
                                    </div>
                                    <p class="text-xs text-gray-500 mt-1">60% da camada de manutenção</p>
                                </div>
                            </div>

                            <!-- Card TIP5.L -->
                            <div class="etf-card bg-white rounded-xl p-6 shadow-md hover:shadow-xl transition-all duration-300 border border-gray-100 cursor-pointer" data-etf="tip5">
                                <div class="mb-4">
                                    <h5 class="font-bold text-gray-800">TIP5</h5>
                                    <p class="text-sm text-gray-600">TIPS 0-5Y</p>
                                </div>
                                
                                <div class="space-y-3">
                                    <div class="flex justify-between items-center">
                                        <span class="text-sm text-gray-600">TER</span>
                                        <span class="font-semibold text-amber-600">0.10%</span>
                                    </div>
                                    <div class="flex justify-between items-center">
                                        <span class="text-sm text-gray-600">AUM</span>
                                        <span class="font-semibold text-amber-600">$1.8B</span>
                                    </div>
                                    <div class="flex justify-between items-center">
                                        <span class="text-sm text-gray-600">Duration</span>
                                        <span class="font-semibold text-amber-600">2.5</span>
                                    </div>
                                </div>

                                <div class="mt-4 pt-4 border-t border-gray-100">
                                    <p class="text-xs text-gray-500 mb-2">Papel na Carteira:</p>
                                    <p class="text-sm text-gray-700">Proteção contra inflação com TIPS de curta duração e baixo risco de taxa.</p>
                                </div>

                                <div class="mt-4">
                                    <div class="w-full bg-amber-100 rounded-full h-3 mb-2" style="background-color: #fef3c7;">
                                        <div class="h-3 rounded-full" style="width: 20%; background-color: #f59e0b; transition: all 0.3s ease;"></div>
                                    </div>
                                    <p class="text-xs text-gray-500 mt-1">20% da camada de manutenção</p>
                                </div>
                            </div>

                            <!-- Card SGLN.L -->
                            <div class="etf-card bg-white rounded-xl p-6 shadow-md hover:shadow-xl transition-all duration-300 border border-gray-100 cursor-pointer" data-etf="sgln">
                                <div class="mb-4">
                                    <h5 class="font-bold text-gray-800">SGLN</h5>
                                    <p class="text-sm text-gray-600">Physical Gold</p>
                                </div>
                                
                                <div class="space-y-3">
                                    <div class="flex justify-between items-center">
                                        <span class="text-sm text-gray-600">TER</span>
                                        <span class="font-semibold text-yellow-600">0.12%</span>
                                    </div>
                                    <div class="flex justify-between items-center">
                                        <span class="text-sm text-gray-600">AUM</span>
                                        <span class="font-semibold text-yellow-600">$13.8B</span>
                                    </div>
                                    <div class="flex justify-between items-center">
                                        <span class="text-sm text-gray-600">Tipo</span>
                                        <span class="font-semibold text-yellow-600">Físico</span>
                                    </div>
                                </div>

                                <div class="mt-4 pt-4 border-t border-gray-100">
                                    <p class="text-xs text-gray-500 mb-2">Papel na Carteira:</p>
                                    <p class="text-sm text-gray-700">Proteção contra inflação e hedge para cenários de stress sistêmico.</p>
                                </div>

                                <div class="mt-4">
                                    <div class="w-full bg-yellow-100 rounded-full h-3 mb-2" style="background-color: #fef3c7;">
                                        <div class="h-3 rounded-full" style="width: 20%; background-color: #eab308; transition: all 0.3s ease;"></div>
                                    </div>
                                    <p class="text-xs text-gray-500 mt-1">20% da camada de manutenção</p>
                                </div>
                                </div>
                            </div>

                        <!-- Botão para Análise Avançada -->
                        <div class="text-center mt-6">
                            <button id="runMaintenanceAnalysis" class="group inline-flex items-center px-6 py-3 bg-gradient-to-r from-orange-600 to-orange-700 text-white rounded-lg hover:from-orange-700 hover:to-orange-800 transition-all duration-300 shadow-lg hover:shadow-xl transform hover:-translate-y-1" style="background: linear-gradient(to right, #ea580c, #c2410c); color: white; border: none;">
                                <svg class="w-4 h-4 mr-2 text-orange-200 group-hover:text-white transition-colors duration-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                                        </svg>
                                <span class="font-medium">Análise Detalhada</span>
                                <svg class="w-4 h-4 ml-2 opacity-0 group-hover:opacity-100 transform translate-x-0 group-hover:translate-x-1 transition-all duration-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6"></path>
                                </svg>
                            </button>
                                    </div>

                        <!-- Loading e Results -->
                        <div id="maintenanceLoading" class="hidden mt-6 text-center">
                            <div class="inline-flex items-center px-4 py-2 border border-orange-300 rounded-full bg-orange-50">
                                <svg class="animate-spin -ml-1 mr-3 h-4 w-4 text-orange-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                </svg>
                                <span class="text-orange-700 font-medium text-sm">Processando análise de manutenção...</span>
                                    </div>
                                </div>
                                
                        <div id="maintenanceResults" class="hidden mt-6">
                            <div class="bg-gradient-to-r from-orange-50 to-amber-50 p-6 rounded-lg border border-orange-200">
                                <h5 class="text-lg font-bold mb-4 text-orange-800">Resultados da Análise de Manutenção</h5>
                                <div id="maintenanceOutput" class="space-y-4">
                                    <!-- Os resultados aparecerão aqui -->
                                    </div>
                                    </div>
                        </div>
                    </div>
                                    </div>
                                </div>

            <!-- Fundos Alternativos para Uso Tático -->
            <div class="bg-white rounded-lg shadow p-6 mb-8">
                <h2 class="text-2xl font-bold mb-6">Fundos Alternativos para Uso Tático</h2>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- SoundPoint Card -->
                    <div class="bg-gradient-to-br from-gray-50 to-slate-50 p-6 rounded-xl border border-gray-200 cursor-pointer hover:shadow-xl transition-all duration-300 transform hover:-translate-y-1" onclick="openModal('soundpointModal')">
                        <div class="flex items-center justify-between mb-4">
                            <h4 class="text-xl font-bold text-gray-800">SoundPoint Capital</h4>
                            <div class="bg-gray-600 text-white px-3 py-1 rounded-full text-xs font-semibold">US$ 43B AUM</div>
                                </div>
                        <p class="text-gray-600 mb-4">Duas estratégias complementares para preservação e manutenção</p>
                        
                        <div class="grid grid-cols-2 gap-3 mb-4">
                            <div class="bg-white p-3 rounded-lg border border-gray-100">
                                <div class="text-xs text-gray-600 font-medium">CLO AAA</div>
                                <div class="text-lg font-bold text-gray-800">+150 bps</div>
                                <div class="text-xs text-gray-500">Preservação</div>
                                    </div>
                            <div class="bg-white p-3 rounded-lg border border-orange-100">
                                <div class="text-xs text-orange-600 font-medium">Capital Solutions</div>
                                <div class="text-lg font-bold text-orange-800">12-14%</div>
                                <div class="text-xs text-gray-500">Manutenção</div>
                            </div>
                        </div>

                        <div class="flex items-center justify-between text-sm">
                            <span class="text-gray-500">Clique para detalhes</span>
                            <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                                        </svg>
                                    </div>
                                    </div>

                    <!-- Hildene Card -->
                    <div class="bg-gradient-to-br from-gray-50 to-slate-50 p-6 rounded-xl border border-gray-200 cursor-pointer hover:shadow-xl transition-all duration-300 transform hover:-translate-y-1" onclick="openModal('hildeneModal')">
                        <div class="flex items-center justify-between mb-4">
                            <h4 class="text-xl font-bold text-gray-800">Hildene Capital</h4>
                            <div class="bg-gray-600 text-white px-3 py-1 rounded-full text-xs font-semibold">US$ 12B AUM</div>
                                </div>
                        <p class="text-gray-600 mb-4">Structured credit e opportunistic distressed com originação própria</p>
                        
                        <div class="grid grid-cols-2 gap-3 mb-4">
                            <div class="bg-white p-3 rounded-lg border border-gray-100">
                                <div class="text-xs text-gray-600 font-medium">Flagship CAGR</div>
                                <div class="text-lg font-bold text-gray-800">~9%</div>
                                <div class="text-xs text-gray-500">Histórico</div>
                                    </div>
                            <div class="bg-white p-3 rounded-lg border border-gray-100">
                                <div class="text-xs text-gray-600 font-medium">Spread vs UST</div>
                                <div class="text-lg font-bold text-gray-800">+300-400 bps</div>
                                <div class="text-xs text-gray-500">Prêmio</div>
                                    </div>
                                </div>

                        <div class="flex items-center justify-between text-sm">
                            <span class="text-gray-500">Clique para detalhes</span>
                            <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                            </svg>
                                </div>
                                    </div>
                                </div>

                
                            </div>

            <!-- Modals -->
            <!-- SoundPoint Modal -->
            <div id="soundpointModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
                <div class="bg-white rounded-xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
                    <div class="p-6">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-2xl font-bold text-gray-800">SoundPoint Capital Management</h3>
                            <button onclick="closeModal('soundpointModal')" class="text-gray-500 hover:text-gray-700">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                        </svg>
                            </button>
                                </div>
                                
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <!-- CLO Strategy -->
                            <div class="bg-gray-50 p-6 rounded-lg border border-gray-200">
                                <h4 class="text-lg font-bold text-gray-800 mb-4">CLO AAA - Preservação</h4>
                                <div class="space-y-3">
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">Spread vs UST 0-3Y:</span>
                                        <span class="font-bold text-gray-700">+150 bps</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">Duration:</span>
                                        <span class="font-bold">< 0.5 anos</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">Rating:</span>
                                        <span class="font-bold">AAA</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">Liquidez:</span>
                                        <span class="font-bold">Semanal</span>
                                </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">Uso sugerido:</span>
                                        <span class="font-bold text-gray-700">Até 10% T-Bills</span>
                                </div>
                                    </div>
                                <div class="mt-4 p-3 bg-white rounded border border-gray-100">
                                    <p class="text-sm text-gray-700">
                                        <strong>Vantagem:</strong> Substitui parcialmente Treasuries mantendo rating AAA e baixa volatilidade.
                                    </p>
                                    <p class="text-sm text-orange-600 mt-2">
                                        <strong>Risco:</strong> Qualidade do gestor.
                                    </p>
                                </div>
                            </div>

                            <!-- Capital Solutions Strategy -->
                            <div class="bg-orange-50 p-6 rounded-lg border border-orange-200">
                                <h4 class="text-lg font-bold text-orange-800 mb-4">Capital Solutions - Manutenção</h4>
                                <div class="space-y-3">
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">Target Net IRR:</span>
                                        <span class="font-bold text-orange-700">12-14%</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">Spread:</span>
                                        <span class="font-bold">SOFR+600-800 bps</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">Duration:</span>
                                        <span class="font-bold">2-3 anos</span>
                                </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">Liquidez:</span>
                                        <span class="font-bold">Mensal</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">Uso sugerido:</span>
                                        <span class="font-bold text-orange-700">10-15% Manutenção</span>
                                    </div>
                                    </div>
                                <div class="mt-4 p-3 bg-white rounded border border-orange-100">
                                    <p class="text-sm text-gray-700">
                                        <strong>Vantagem:</strong> Direct lending 1st-lien, 73% IG, zero perdas desde 2015.
                                    </p>
                                    <p class="text-sm text-orange-600 mt-2">
                                        <strong>Risco:</strong> Lock-up 1 ano e monitoramento constante necessário.
                                    </p>
                                </div>
                            </div>
                                </div>

                        <!-- Performance Table -->
                        <div class="mt-6">
                            <h5 class="font-bold text-gray-800 mb-3">Histórico de Performance</h5>
                            <div class="overflow-x-auto">
                                <table class="w-full text-sm border-collapse border border-gray-200">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="border border-gray-200 p-2 text-left">Fundo</th>
                                            <th class="border border-gray-200 p-2 text-center">Período</th>
                                            <th class="border border-gray-200 p-2 text-center">IRR Bruta</th>
                                            <th class="border border-gray-200 p-2 text-center">IRR Líquida</th>
                                            <th class="border border-gray-200 p-2 text-center">Perdas</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td class="border border-gray-200 p-2 font-medium">SCF I</td>
                                            <td class="border border-gray-200 p-2 text-center">2018-24</td>
                                            <td class="border border-gray-200 p-2 text-center">12.8%</td>
                                            <td class="border border-gray-200 p-2 text-center">~10%</td>
                                            <td class="border border-gray-200 p-2 text-center">Zero</td>
                                        </tr>
                                        <tr class="bg-gray-25">
                                            <td class="border border-gray-200 p-2 font-medium">SCF II</td>
                                            <td class="border border-gray-200 p-2 text-center">2022-24</td>
                                            <td class="border border-gray-200 p-2 text-center">16.5%</td>
                                            <td class="border border-gray-200 p-2 text-center">12-13.5%</td>
                                            <td class="border border-gray-200 p-2 text-center">Zero</td>
                                        </tr>
                                    </tbody>
                                </table>
                                    </div>
                        </div>
                    </div>
                                </div>
                            </div>

            <!-- Hildene Modal -->
            <div id="hildeneModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
                <div class="bg-white rounded-xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
                    <div class="p-6">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-2xl font-bold text-gray-800">Hildene Capital Management</h3>
                            <button onclick="closeModal('hildeneModal')" class="text-gray-500 hover:text-gray-700">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                        </svg>
                            </button>
                                </div>
                                
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <!-- Strategy Overview -->
                            <div class="bg-gray-50 p-6 rounded-lg border border-gray-200">
                                <h4 class="text-lg font-bold text-gray-800 mb-4">Estratégia Principal</h4>
                                <div class="space-y-3">
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">AUM:</span>
                                        <span class="font-bold">US$ 12 bi</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">Flagship CAGR:</span>
                                        <span class="font-bold text-gray-700">~9%</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">Max DD (2020):</span>
                                        <span class="font-bold">-8%</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">Spread vs UST:</span>
                                        <span class="font-bold text-gray-700">+300-400 bps</span>
                                </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">Uso sugerido:</span>
                                        <span class="font-bold text-gray-700">10-15% PIMCO</span>
                                </div>
                            </div>
                        </div>

                            <!-- Asset Classes -->
                            <div class="bg-slate-50 p-6 rounded-lg border border-slate-200">
                                <h4 class="text-lg font-bold text-slate-800 mb-4">Classes de Ativos</h4>
                                <div class="space-y-2">
                                    <div class="flex items-center justify-between p-2 bg-white rounded">
                                        <span class="text-sm">TruPS CDOs</span>
                                        <span class="text-xs bg-slate-100 text-slate-700 px-2 py-1 rounded">Core</span>
                                    </div>
                                    <div class="flex items-center justify-between p-2 bg-white rounded">
                                        <span class="text-sm">Mezz CLOs</span>
                                        <span class="text-xs bg-slate-100 text-slate-700 px-2 py-1 rounded">Core</span>
                                </div>
                                    <div class="flex items-center justify-between p-2 bg-white rounded">
                                        <span class="text-sm">Non-QM RMBS</span>
                                        <span class="text-xs bg-slate-100 text-slate-700 px-2 py-1 rounded">Opp</span>
                                    </div>
                                    <div class="flex items-center justify-between p-2 bg-white rounded">
                                        <span class="text-sm">Bank Restructuring</span>
                                        <span class="text-xs bg-slate-100 text-slate-700 px-2 py-1 rounded">Dist</span>
                                </div>
                                    </div>
                                </div>
                            </div>

                        <!-- Advantages and Risks -->
                        <div class="mt-6 grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <div class="bg-white p-4 rounded-lg border border-gray-200">
                                <h5 class="font-bold text-gray-800 mb-3">Características Típicas</h5>
                                <ul class="text-sm space-y-2">
                                    <li>• Prêmio de iliquidez vs ETFs tradicionais</li>
                                    <li>• Especialização em structured credit</li>
                                    <li>• Capacidade de originação própria</li>
                                    <li>• Rotação ativa entre ciclos</li>
                                    </ul>
                                <p class="text-xs text-gray-500 mt-3 italic">*Características típicas do setor</p>
                            </div>
                            <div class="bg-white p-4 rounded-lg border border-gray-200">
                                <h5 class="font-bold text-gray-800 mb-3">Considerações Gerais</h5>
                                <ul class="text-sm space-y-2">
                                    <li>• Valuation de ativos ilíquidos</li>
                                    <li>• Perfil de risco diferenciado</li>
                                    <li>• Estruturas de liquidez específicas</li>
                                    </ul>
                                <p class="text-xs text-gray-500 mt-3 italic">*Due diligence específica necessária</p>
                            </div>
                        </div>
                        </div>
                    </div>
                </div>

            <!-- Camada de Ganho -->
            <div class="bg-blue-50 p-6 rounded-lg mb-8 border border-blue-200">
                <h3 class="text-xl font-bold mb-4">Camada de Ganho (25% da carteira total)</h3>
                <p class="text-sm mb-6">Exposição direta ao S&P 500 via VUAA ETF para captura de crescimento estrutural</p>
                
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <!-- Gráfico de alocação do ganho -->
                    <div class="bg-white p-6 rounded-lg shadow-sm">
                        <h4 class="text-lg font-semibold mb-4 text-center">Distribuição da Camada</h4>
                        <div class="w-full" style="height: 400px;">
                            <canvas id="growthChart"></canvas>
                        </div>
                    </div>

                    <!-- Detalhamento do ganho -->
                    <div class="space-y-4">
                        <div class="bg-white p-4 rounded-lg shadow-sm border-l-4 border-red-900">
                    <div class="flex justify-between items-center">
                        <div>
                                    <h5 class="font-semibold text-gray-800">VUAA - S&P 500 ETF</h5>
                                    <p class="text-sm text-gray-600">Exposição direta ao mercado americano</p>
                        </div>
                                <span class="text-lg font-bold text-red-900">100%</span>
                        </div>
                        </div>

                        <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-100">
                            <h5 class="font-semibold text-gray-800 mb-3">Características do VUAA</h5>
                            <div class="space-y-2 text-sm">
                                <div class="flex justify-between">
                                    <span class="text-gray-600">TER:</span>
                                    <span class="font-semibold">0.07%</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">AUM:</span>
                                    <span class="font-semibold">€8.5B</span>
                    </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Replicação:</span>
                                    <span class="font-semibold">Física</span>
                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Dividendos:</span>
                                    <span class="font-semibold">Acumulação</span>
                        </div>
                        </div>
                    </div>

                        <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-100">
                            <h5 class="font-semibold text-gray-800 mb-3">Papel na Carteira</h5>
                            <p class="text-sm text-gray-700">
                                Exposição pura ao S&P 500 para capturar o crescimento estrutural da economia americana, 
                                aproveitando a inovação tecnológica e expansão de mercados.
                            </p>
                                </div>
                            </div>
                        </div>

            
                        
                <!-- Botão para Análise Avançada -->
                <div class="text-center mt-6">
                    <button id="runGrowthAnalysis" class="group inline-flex items-center px-6 py-3 bg-gradient-to-r from-red-600 to-red-700 text-white rounded-lg hover:from-red-700 hover:to-red-800 transition-all duration-300 shadow-lg hover:shadow-xl transform hover:-translate-y-1">
                        <svg class="w-4 h-4 mr-2 text-red-200 group-hover:text-white transition-colors duration-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                        </svg>
                        <span class="font-medium">Análise Detalhada</span>
                        <svg class="w-4 h-4 ml-2 opacity-0 group-hover:opacity-100 transform translate-x-0 group-hover:translate-x-1 transition-all duration-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6"></path>
                        </svg>
                    </button>
                                </div>

                    <!-- Loading e Results -->
                    <div id="growthLoading" class="hidden mt-6 text-center">
                        <div class="inline-flex items-center px-4 py-2 border border-red-300 rounded-full bg-red-50">
                            <svg class="animate-spin -ml-1 mr-3 h-4 w-4 text-red-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                            <span class="text-red-700 font-medium text-sm">Processando análise de ganho...</span>
                            </div>
                        </div>

                    <div id="growthResults" class="hidden mt-6">
                        <div class="bg-gradient-to-r from-blue-50 to-slate-50 p-6 rounded-lg border border-blue-200">
                            <h5 class="text-lg font-bold mb-4 text-blue-800">Resultados da Análise de Ganho</h5>
                            <div id="growthOutput" class="space-y-4">
                                <!-- Os resultados aparecerão aqui -->
                                </div>
                            </div>
                        </div>

                    <!-- Schonfeld Strategic Advisors Card -->
                    <div class="mt-8">
                        <h4 class="text-lg font-bold mb-4 text-gray-800">Gestão Institucional Complementar</h4>
                        <div class="bg-gradient-to-br from-gray-50 to-slate-50 p-6 rounded-xl border border-gray-200 cursor-pointer hover:shadow-xl transition-all duration-300 transform hover:-translate-y-1" onclick="openModal('schonfeldModal')">
                            <div class="flex items-center justify-between mb-4">
                                <h5 class="text-xl font-bold text-gray-800">Schonfeld Strategic Advisors</h5>
                                <div class="bg-gray-600 text-white px-3 py-1 rounded-full text-xs font-semibold">US$ 146B AUM</div>
                                </div>
                            <p class="text-gray-600 mb-4">Multi-estratégia com performance excepcional em 2024 - Líder do setor</p>
                            
                            <div class="grid grid-cols-2 gap-3 mb-4">
                                <div class="bg-white p-3 rounded-lg border border-gray-100">
                                    <div class="text-xs text-gray-600 font-medium">Strategic Partners 2024</div>
                                    <div class="text-lg font-bold text-gray-800">19,7%</div>
                                    <div class="text-xs text-gray-500">Flagship Fund</div>
                            </div>
                                <div class="bg-white p-3 rounded-lg border border-gray-100">
                                    <div class="text-xs text-gray-600 font-medium">Fundamental Equity 2024</div>
                                    <div class="text-lg font-bold text-gray-800">21,1%</div>
                                    <div class="text-xs text-gray-500">Equity Strategy</div>
            </div>
        </div>

                            <div class="flex items-center justify-between text-sm">
                                <span class="text-gray-500">Clique para detalhes</span>
                                <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                                </svg>
                        </div>
                        </div>
                        </div>
                    </div>
                </div>

            <!-- Schonfeld Modal -->
            <div id="schonfeldModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
                <div class="bg-white rounded-xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
                    <div class="p-6">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-2xl font-bold text-gray-800">Schonfeld Strategic Advisors</h3>
                            <button onclick="closeModal('schonfeldModal')" class="text-gray-500 hover:text-gray-700">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </button>
                </div>

                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <!-- Performance 2024 -->
                <div class="bg-gray-50 p-6 rounded-lg border border-gray-200">
                                <h4 class="text-lg font-bold text-gray-800 mb-4">Performance 2024 - Líder do Setor</h4>
                                <div class="space-y-3">
                        <div class="flex justify-between">
                                        <span class="text-gray-600">Strategic Partners:</span>
                                        <span class="font-bold text-gray-700">19,7%</span>
                        </div>
                        <div class="flex justify-between">
                                        <span class="text-gray-600">Fundamental Equity:</span>
                                        <span class="font-bold text-gray-700">21,1%</span>
                        </div>
                        <div class="flex justify-between">
                                        <span class="text-gray-600">Performance mensal:</span>
                                        <span class="font-bold">Positivo todos os meses</span>
                        </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">Ranking:</span>
                                        <span class="font-bold text-gray-700">#1 Multi-Strategy</span>
                    </div>
                </div>
                                <div class="mt-4 p-3 bg-white rounded border border-gray-100">
                                    <p class="text-sm text-gray-700">
                                        <strong>Destaque:</strong> Liderou fundos multi-estratégia em 2024 após recuperação extraordinária.
                                    </p>
            </div>
        </div>

                            <!-- Perfil da Casa -->
                            <div class="bg-gray-50 p-6 rounded-lg border border-gray-200">
                                <h4 class="text-lg font-bold text-gray-800 mb-4">Perfil Institucional</h4>
                                <div class="space-y-3">
                        <div class="flex justify-between">
                                        <span class="text-gray-600">AUM Total:</span>
                                        <span class="font-bold">US$ 146B</span>
                        </div>
                        <div class="flex justify-between">
                                        <span class="text-gray-600">Fundado:</span>
                                        <span class="font-bold">2015</span>
                        </div>
                        <div class="flex justify-between">
                                        <span class="text-gray-600">Estratégias:</span>
                                        <span class="font-bold">Multi-Strategy</span>
                        </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">Equipe 2024:</span>
                                        <span class="font-bold">+40 profissionais</span>
                    </div>
                </div>
                                <div class="mt-4 p-3 bg-white rounded border border-gray-100">
                                    <p class="text-sm text-gray-700">
                                        <strong>Foco:</strong> Quantitative equities, tactical trading e global macro.
                                    </p>
                        </div>
                        </div>
                        </div>

                        <!-- Comparação Rápida -->
                        <div class="mt-6">
                            <h5 class="font-bold text-gray-800 mb-3">Comparação Multi-Strategy 2024</h5>
                            <div class="overflow-x-auto">
                                <table class="w-full text-sm border-collapse border border-gray-200">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="border border-gray-200 p-2 text-left">Gestor</th>
                                            <th class="border border-gray-200 p-2 text-center">Retorno 2024</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr class="bg-gray-100">
                                            <td class="border border-gray-200 p-2 font-medium">Schonfeld Strategic</td>
                                            <td class="border border-gray-200 p-2 text-center font-bold text-gray-700">19,7%</td>
                                        </tr>
                                        <tr>
                                            <td class="border border-gray-200 p-2">D.E. Shaw</td>
                                            <td class="border border-gray-200 p-2 text-center">18,0%</td>
                                        </tr>
                                        <tr class="bg-gray-25">
                                            <td class="border border-gray-200 p-2">Walleye Capital</td>
                                            <td class="border border-gray-200 p-2 text-center">17,7%</td>
                                        </tr>
                                        <tr>
                                            <td class="border border-gray-200 p-2">Millennium</td>
                                            <td class="border border-gray-200 p-2 text-center">15,0%</td>
                                        </tr>
                                    </tbody>
                                </table>
                    </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Botão para Análise Avançada -->
            <div class="mt-8 text-center">
                <button id="runStressTestGlobal" class="group inline-flex items-center px-8 py-4 bg-gradient-to-r from-black to-black text-white rounded-lg hover:from-black-700 hover:to-black-800 transition-all duration-300 shadow-lg hover:shadow-xl transform hover:-translate-y-1">
                    <svg class="w-5 h-5 mr-3 text-blue-200 group-hover:text-white transition-colors duration-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                    </svg>
                    <span class="font-semibold tracking-wide">Executar Análise Final</span>
                    <svg class="w-4 h-4 ml-3 opacity-0 group-hover:opacity-100 transform translate-x-0 group-hover:translate-x-1 transition-all duration-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6"></path>
                    </svg>
                </button>
                <p class="text-sm text-gray-500 mt-2">Análise completa dos dados da carteira</p>
            </div>

            <!-- Loading e Results -->
            <div id="pythonLoadingGlobal" class="hidden mt-6 text-center">
                <div class="inline-flex items-center px-4 py-2 border border-blue-300 rounded-full bg-blue-50">
                    <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <span class="text-blue-700 font-medium">Carregando e executando análise...</span>
                </div>
            </div>

            <div id="pythonResultsGlobal" class="hidden mt-6">
                <div class="bg-gray-50 p-6 rounded-lg border">
                    <h4 class="text-lg font-bold mb-4">Resultados da Análise</h4>
                    <div id="stressTestOutputGlobal" class="space-y-4">
                        <!-- Os resultados aparecerão aqui -->
                    </div>
                </div>
            </div>
        </div>

        
    </div>

    <!-- Botão Voltar ao Topo Flutuante -->
    <button id="scrollToTop" 
           onclick="window.scrollTo({top: 0, behavior: 'smooth'})" 
           class="fixed bottom-8 right-8 p-3 bg-gray-900 text-white rounded-full 
                  hover:bg-gray-800 transition-all duration-300 
                  border border-gray-700 hover:border-gray-600
                  shadow-lg hover:shadow-xl
                  backdrop-filter backdrop-blur-sm
                  opacity-0 invisible
                  group z-40">
        <svg class="w-5 h-5 text-gray-400 group-hover:text-white transition-colors duration-300" 
             fill="none" 
             stroke="currentColor" 
             viewBox="0 0 24 24">
            <path stroke-linecap="round" 
                  stroke-linejoin="round" 
                  stroke-width="2" 
                  d="M5 10l7-7m0 0l7 7m-7-7v18"/>
        </svg>
    </button>

    <footer class="bg-gray-900 text-white py-8 mt-12">
        <div class="container mx-auto px-4">
            <div class="text-center">
                <p class="mb-2">Desenvolvido por Marcius Lima</p>
                <p class="text-sm text-gray-400">Última atualização: 14 de junho de 2025</p>
                <p class="mt-4 text-sm text-gray-400">© 2025 - Todos os direitos reservados</p>
            </div>
        </div>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            
            // Botão Voltar ao Topo - Aparecer/Desaparecer com Scroll
            const scrollToTopBtn = document.getElementById('scrollToTop');
            
            window.addEventListener('scroll', function() {
                if (window.pageYOffset > 300) {
                    scrollToTopBtn.classList.remove('opacity-0', 'invisible');
                    scrollToTopBtn.classList.add('opacity-100', 'visible');
                } else {
                    scrollToTopBtn.classList.add('opacity-0', 'invisible');
                    scrollToTopBtn.classList.remove('opacity-100', 'visible');
                }
            });
            
            // Forçar renderização dos ícones SVG e barras de progresso
            setTimeout(function() {
                const etfCards = document.querySelectorAll('.etf-card');
                etfCards.forEach(card => {
                    const svg = card.querySelector('svg');
                    const progressBar = card.querySelector('[class*="bg-orange-600"], [class*="bg-amber-600"], [class*="bg-yellow-600"]');
                    
                    if (svg) {
                        svg.style.display = 'block';
                        svg.style.opacity = '1';
                        svg.style.visibility = 'visible';
                    }
                    
                    if (progressBar) {
                        progressBar.style.opacity = '1';
                        progressBar.style.visibility = 'visible';
                    }
                });
            }, 100);
            
            // Gráfico da Camada de Preservação - Degradê de Azul
            const ctxPreservation = document.getElementById('preservationChart').getContext('2d');
            new Chart(ctxPreservation, {
                type: 'doughnut',
                data: {
                    labels: ['U03A (0-3M T-Bills)', 'IBTA.L (1-3Y Treasury)', 'TFRN.L (Floating Rate)'],
                    datasets: [{
                        data: [60, 20, 20],
                        backgroundColor: [
                            'rgba(30, 58, 138, 0.9)',     // blue-900 - U03A
                            'rgba(30, 64, 175, 0.9)',     // blue-800 - IBTA.L
                            'rgba(29, 78, 216, 0.9)'      // blue-700 - TFRN.L
                        ],
                        borderWidth: 0,
                        hoverBorderWidth: 3,
                        hoverBorderColor: 'rgba(255, 255, 255, 0.8)'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 20,
                                font: {
                                    size: 12,
                                    weight: '500'
                                },
                                color: '#1e3a8a'
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.label + ': ' + context.parsed + '%';
                                }
                            },
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            titleColor: 'white',
                            bodyColor: 'white'
                        }
                    }
                }
            });

            // Gráfico da Camada de Manutenção - Degradê de Laranja
            const ctxMaintenance = document.getElementById('maintenanceChart').getContext('2d');
            new Chart(ctxMaintenance, {
                type: 'doughnut',
                data: {
                    labels: ['PIMCO Income', 'TIP5 - TIPS 0-5Y', 'SGLN - Ouro'],
                    datasets: [{
                        data: [60, 20, 20],
                        backgroundColor: [
                            'rgba(194, 65, 12, 0.9)',    // orange-800
                            'rgba(234, 88, 12, 0.9)',    // orange-600
                            'rgba(251, 146, 60, 0.9)'    // orange-400
                        ],
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 15,
                                font: {
                                    size: 12
                                }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.label + ': ' + context.parsed + '%';
                                }
                            }
                        }
                    }
                }
            });

            // Funcionalidade das Abas dos ETFs
            const tabButtons = document.querySelectorAll('.etf-tab-btn');
            const tabContents = document.querySelectorAll('.etf-tab-content');

            tabButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const targetTab = this.getAttribute('data-tab');
                    
                    // Remove active class from all buttons
                    tabButtons.forEach(btn => {
                        btn.classList.remove('active', 'border-blue-600', 'text-blue-600');
                        btn.classList.add('border-transparent', 'text-gray-500');
                    });
                    
                    // Add active class to clicked button
                    this.classList.add('active', 'border-blue-600', 'text-blue-600');
                    this.classList.remove('border-transparent', 'text-gray-500');
                    
                    // Hide all tab contents
                    tabContents.forEach(content => {
                        content.classList.add('hidden');
                    });
                    
                    // Show target tab content
                    const targetContent = document.getElementById(`tab-${targetTab}`);
                    if (targetContent) {
                        targetContent.classList.remove('hidden');
                    }
                });
            });

            // Adicionar funcionalidade de clique nos cards dos ETFs
            const etfCards = document.querySelectorAll('.etf-card');
            
            etfCards.forEach(card => {
                card.addEventListener('click', function() {
                    const etfType = this.getAttribute('data-etf');
                    let url = '';
                    
                    switch(etfType) {
                        // ETFs da Camada de Preservação
                        case 'u03a':
                            url = 'https://markets.ft.com/data/etfs/tearsheet/summary?s=U03A:LSE:USD';
                            break;
                        case 'ibta':
                            url = 'https://markets.ft.com/data/etfs/tearsheet/summary?s=IBTA:LSE:USD';
                            break;
                        case 'tfrn':
                            url = 'https://markets.ft.com/data/etfs/tearsheet/summary?s=TFRN:LSE:USD';
                            break;
                        
                        // ETFs da Camada de Manutenção
                        case 'ihyg':
                            url = 'https://markets.ft.com/data/etfs/tearsheet/summary?s=IHYG:LSE:USD';
                            break;
                        case 'shyu':
                            url = 'https://markets.ft.com/data/etfs/tearsheet/summary?s=SHYU:LSE:EUR';
                            break;
                        case 'emhg':
                            url = 'https://markets.ft.com/data/etfs/tearsheet/summary?s=EMHG:LSE:USD';
                            break;
                        case 'ihya':
                            url = 'https://markets.ft.com/data/etfs/tearsheet/summary?s=IHYA:LSE:USD';
                            break;
                        case 'pimco-income':
                            url = 'https://www.pimco.com/sg/en/investments/gis/income-fund/e-usd-accumulation';
                            break;
                        case 'tip5':
                            url = 'https://www.ishares.com/uk/individual/en/products/287202/ishares-tips-0-5-ucits-etf';
                            break;
                        case 'ib01':
                            url = 'https://markets.ft.com/data/etfs/tearsheet/summary?s=IB01:LSE:GBP';
                            break;
                        case 'cloa':
                            url = 'https://markets.ft.com/data/etfs/tearsheet/summary?s=CLOA:NASDAQ:USD';
                            break;
                        case 'sgln':
                            url = 'https://www.ishares.com/uk/individual/en/products/258441/ishares-physical-gold-etc';
                            break;
                        
                        default:
                            console.log('ETF não encontrado:', etfType);
                            return;
                    }
                    
                    // Abrir a página oficial do ETF
                    window.open(url, '_blank');
                });
                
                // Adicionar efeito visual de hover
                card.addEventListener('mouseenter', function() {
                    this.style.transform = 'translateY(-2px)';
                    this.style.boxShadow = '0 10px 25px rgba(0, 0, 0, 0.15)';
                });
                
                card.addEventListener('mouseleave', function() {
                    this.style.transform = 'translateY(0)';
                    this.style.boxShadow = '';
                });
            });

            // Gráfico da Camada de Ganho - 100% VUAA em Vermelho
            const ctxGrowth = document.getElementById('growthChart').getContext('2d');
            new Chart(ctxGrowth, {
                type: 'doughnut',
                data: {
                    labels: ['VUAA - S&P 500 ETF'],
                    datasets: [{
                        data: [100],
                        backgroundColor: [
                            'rgba(185, 28, 28, 0.9)'    // red-700
                        ],
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 15,
                                font: {
                                    size: 12,
                                    weight: '500'
                                },
                                color: '#b91c1c'
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.label + ': ' + context.parsed + '%';
                                }
                            }
                        }
                    }
                }
            });
        });

        // Análise de Manutenção
        document.getElementById('runMaintenanceAnalysis')?.addEventListener('click', async function() {
            const button = this;
            const loadingDiv = document.getElementById('maintenanceLoading');
            const resultsDiv = document.getElementById('maintenanceResults');
            const outputDiv = document.getElementById('maintenanceOutput');
            
            // UI feedback
            button.disabled = true;
            button.classList.add('opacity-50');
            loadingDiv.classList.remove('hidden');
            resultsDiv.classList.add('hidden');
            
            try {
                // Inicializar Pyodide
                const pyodide = await initPyodide();
                
                // Código Python usando dados REAIS da API Supabase
                const pythonCode = `
import numpy as np
import pandas as pd
from datetime import datetime, timedelta
import matplotlib.pyplot as plt
import matplotlib.dates as mdates
from io import BytesIO
import base64
import js
import json

# Configurar matplotlib para gráficos interativos
plt.style.use('default')
plt.rcParams['figure.facecolor'] = '#ffffff'
plt.rcParams['axes.facecolor'] = '#fafafa'
plt.rcParams['axes.spines.top'] = False
plt.rcParams['axes.spines.right'] = False
plt.rcParams['axes.grid'] = True
plt.rcParams['grid.alpha'] = 0.3
plt.rcParams['grid.color'] = '#e5e7eb'
plt.rcParams['grid.linestyle'] = '-'
plt.rcParams['grid.linewidth'] = 0.8
plt.rcParams['font.family'] = 'sans-serif'
plt.rcParams['font.size'] = 11
plt.rcParams['axes.linewidth'] = 1.2
plt.rcParams['lines.linewidth'] = 2.5
plt.rcParams['axes.edgecolor'] = '#64748b'
plt.rcParams['axes.labelcolor'] = '#374151'
plt.rcParams['text.color'] = '#374151'
plt.rcParams['xtick.color'] = '#6b7280'
plt.rcParams['ytick.color'] = '#6b7280'

# Paleta de cores para manutenção
PRIMARY_ORANGE = '#ea580c'
SECONDARY_ORANGE = '#fb923c'
ACCENT_ORANGE = '#fed7aa'
DARK_ORANGE = '#c2410c'
LIGHT_ORANGE = '#ffedd5'
GRAY_ORANGE = '#78716c'

# ── PARÂMETROS seguindo o código de referência ─────────────────────────────────────────────── #
START_DATE = "2019-01-12"
RF = 0.0  # Sharpe absoluto

# Mapeamento para API - alguns tickers precisam ser mapeados
TICKER_MAP = {
    "TIP5.L": "TIP5.L",  # Tentar primeiro com .L
    "SGLN.L": "SGLN.L",  # Tentar primeiro com .L
    "HYG": "HYG"
}

WEIGHTS = {
    "PIMCO": 0.60,
    "TIP5.L": 0.20,
    "SGLN.L": 0.20,
}
BENCH_TKR = "HYG"

STRESS = {
    "COVID 2020": ("2020-02-19", "2020-03-23"),
    "Election 24": ("2024-10-15", "2024-12-15"),
}

def fetch_etf_data(symbol, base_url, api_key):
    """Busca dados reais via API Supabase com fallback para diferentes formatos de ticker"""
    # Lista de possíveis variações do ticker para tentar
    possible_tickers = [
        symbol,  # Ticker original
        TICKER_MAP.get(symbol, symbol),  # Mapeamento
        symbol.replace('.L', ''),  # Sem .L
        symbol.replace('.L', '.LON'),  # Com .LON
        symbol + '.L' if '.L' not in symbol else symbol.replace('.L', '')  # Toggle .L
    ]
    
    # Remover duplicatas mantendo ordem
    seen = set()
    unique_tickers = []
    for ticker in possible_tickers:
        if ticker not in seen:
            seen.add(ticker)
            unique_tickers.append(ticker)
    
    last_error = None
    
    for api_symbol in unique_tickers:
        try:
            url = f"{base_url}/rest/v1/json_data?id=eq.{api_symbol}"
            
            xhr_code = f"""
            (() => {{
                const xhr = new XMLHttpRequest();
                xhr.open('GET', '{url}', false);
                xhr.setRequestHeader('apikey', '{api_key}');
                xhr.setRequestHeader('Authorization', 'Bearer {api_key}');
                xhr.setRequestHeader('Content-Type', 'application/json');
                
                try {{
                    xhr.send();
                    return {{
                        success: xhr.status >= 200 && xhr.status < 300,
                        responseText: xhr.responseText,
                        status: xhr.status
                    }};
                }} catch (error) {{
                    return {{ success: false, error: error.message, status: 0 }};
                }}
            }})()
            """
            
            result = js.eval(xhr_code)
            
            if not result.success:
                last_error = f"HTTP {result.status} para {api_symbol}"
                continue
            
            data = json.loads(str(result.responseText))
            if not data or len(data) == 0:
                last_error = f"Dados vazios para {api_symbol}"
                continue
            
            raw_data = data[0]['data']
            
            # Extrair preços
            prices = {}
            for date_str, val in raw_data.items():
                try:
                    if isinstance(val, dict):
                        price = val.get('close', val.get('value', 0))
                        if price == 0:
                            for k, v in val.items():
                                if isinstance(v, (int, float)) and v > 0:
                                    price = v
                                    break
                    else:
                        price = float(val)
                    
                    if price > 0:
                        prices[date_str] = price
                except:
                    continue
            
            if len(prices) < 50:
                last_error = f"Dados insuficientes para {api_symbol} ({len(prices)} pontos)"
                continue
            
            # Sucesso! Converter para Series
            price_series = pd.Series(prices)
            price_series.index = pd.to_datetime(price_series.index)
            price_series = price_series.sort_index()
            price_series = price_series[price_series > 0].dropna()
            
            print(f"✓ Sucesso: {symbol} encontrado como {api_symbol} ({len(price_series)} pontos)")
            return price_series
            
        except Exception as e:
            last_error = f"Erro {api_symbol}: {str(e)}"
            continue
    
    # Se chegou aqui, nenhuma variação funcionou
    raise Exception(f"Dados não encontrados para {symbol}. Tentativas: {unique_tickers}. Último erro: {last_error}")

def fetch_pimco_data():
    """Busca dados reais do PIMCO via API"""
    try:
        return fetch_etf_data("PIMCO", API_URL, API_KEY)
    except Exception as e:
        print(f"Erro ao buscar PIMCO: {e}")
        # Se não conseguir PIMCO, usar dados simulados baseados em performance real
        dates = pd.date_range(start=START_DATE, end='2024-12-31', freq='D')
        dates = dates[dates.weekday < 5]
        
        prices = np.zeros(len(dates))
        initial_price = 10.15
        prices[0] = initial_price
        
        base_return = 0.00018
        volatility = 0.0025
        
        for i, date in enumerate(dates[1:], 1):
            prev_price = prices[i-1]
            daily_return = base_return
            
            year = date.year
            
            if year == 2019:
                daily_return += 0.0006
            elif year == 2020:
                if date.month >= 2 and date.month <= 4:
                    daily_return -= 0.0012
                elif date.month >= 5:
                    daily_return += 0.0010
            elif year == 2021:
                daily_return += 0.0008
            elif year == 2022:
                daily_return -= 0.0006
            elif year == 2023:
                daily_return += 0.0008
            elif year == 2024:
                daily_return += 0.0005
            
            daily_return += np.random.normal(0, volatility)
            prices[i] = prev_price * (1 + daily_return)
        
        return pd.Series(prices, index=dates)

def list_available_tickers(base_url, api_key):
    """Lista tickers disponíveis na API para debug"""
    try:
        url = f"{base_url}/rest/v1/json_data?select=id"
        
        xhr_code = f"""
        (() => {{
            const xhr = new XMLHttpRequest();
            xhr.open('GET', '{url}', false);
            xhr.setRequestHeader('apikey', '{api_key}');
            xhr.setRequestHeader('Authorization', 'Bearer {api_key}');
            xhr.setRequestHeader('Content-Type', 'application/json');
            
            try {{
                xhr.send();
                return {{
                    success: xhr.status >= 200 && xhr.status < 300,
                    responseText: xhr.responseText
                }};
            }} catch (error) {{
                return {{ success: false, error: error.message }};
            }}
        }})()
        """
        
        result = js.eval(xhr_code)
        
        if result.success:
            data = json.loads(str(result.responseText))
            tickers = [item['id'] for item in data]
            return tickers
        else:
            return []
    except:
        return []

def create_interactive_plot(fig):
    """Converte plot para base64 com estilo profissional"""
    buffer = BytesIO()
    fig.savefig(buffer, format='png', dpi=100, bbox_inches='tight', 
                facecolor='white', edgecolor='none', pad_inches=0.2)
    buffer.seek(0)
    image_base64 = base64.b64encode(buffer.getvalue()).decode('utf-8')
    buffer.close()
    plt.close(fig)
    
    # Limpar dados problemáticos
    image_base64 = image_base64.replace('\\\\n', '').replace('\\\\r', '').replace('\\\\t', '')
    
    return f"data:image/png;base64,{image_base64}"

def port_series(pr, w):
    """Calcula série da carteira seguindo o código de referência"""
    ret = pr.pct_change().dropna()
    return (1 + (ret * pd.Series(w)).sum(axis=1)).cumprod()

def cagr(s):
    """Calcula CAGR de uma série de preços"""
    yrs = (s.index[-1] - s.index[0]).days / 365.25
    return (s.iloc[-1] / s.iloc[0]) ** (1/yrs) - 1

def vol(s):
    """Calcula volatilidade anualizada"""
    return s.pct_change().std() * np.sqrt(252)

def max_dd(s):
    """Calcula drawdown máximo"""
    return ((s / s.expanding().max()) - 1).min()

def scen_stats(s, ini, fim):
    """Calcula métricas de cenário seguindo o código de referência"""
    ini_ts, fim_ts = pd.Timestamp(ini), pd.Timestamp(fim)
    if ini_ts not in s.index or fim_ts not in s.index:
        return np.nan, np.nan
    dd = (s.loc[ini_ts:fim_ts] / s.loc[:ini_ts].max() - 1).min()
    try:
        rec = s.loc[fim_ts:][s.loc[fim_ts:] >= s.loc[:ini_ts].max()].index[0]
        days = (rec - fim_ts).days
    except IndexError:
        days = np.nan
    return dd, days

# Configuração da API
API_URL = "https://zpfjprlbvkvwvobijznt.supabase.co"
API_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpwZmpwcmxidmt2d3ZvYmlqem50Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDk2MDI5OTIsImV4cCI6MjA2NTE3ODk5Mn0.oK0k1cMerMUkvwLyggu-vJfdixPhZLvWW39MbQLFDyI"

print("Carregando dados REAIS para análise de manutenção...")

# Primeiro, vamos listar os tickers disponíveis para debug
available_tickers = list_available_tickers(API_URL, API_KEY)
print(f"Tickers disponíveis na API: {available_tickers[:10]}...")  # Mostrar apenas os primeiros 10

# ── DOWNLOAD PREÇOS REAIS seguindo o código de referência ─────────────────────────────────── #
etf_tickers = [t for t in WEIGHTS if t != "PIMCO"] + [BENCH_TKR]
prices_data = {}

# Buscar dados dos ETFs REAIS
for ticker in etf_tickers:
    if ticker != BENCH_TKR:
        try:
            print(f"Processando {ticker}...")
            prices_data[ticker] = fetch_etf_data(ticker, API_URL, API_KEY)
        except Exception as e:
            print(f"Erro {ticker}: {str(e)}")
            raise Exception(f"Dados indisponíveis para {ticker}")

# Buscar benchmark REAL separadamente
try:
    print(f"Processando benchmark {BENCH_TKR}...")
    bench = fetch_etf_data(BENCH_TKR, API_URL, API_KEY)
except Exception as e:
    print(f"Erro benchmark: {str(e)}")
    raise Exception(f"Dados indisponíveis para benchmark {BENCH_TKR}")

# ── CARREGA PIMCO REAL seguindo o código de referência ────────────────────────────────────── #
print("Processando PIMCO Income...")
pimco_data = fetch_pimco_data()
prices_data["PIMCO"] = pimco_data

# Criar DataFrame de preços
prices = pd.DataFrame(prices_data).ffill().dropna()

# Alinha benchmark com período dos preços
common_dates = prices.index.intersection(bench.index)
prices = prices.loc[common_dates]
bench = bench.loc[common_dates]

print(f"Dados processados: {len(prices)} observações")
print(f"Período: {common_dates[0].strftime('%Y-%m-%d')} até {common_dates[-1].strftime('%Y-%m-%d')}")

# ── CARTEIRA E BENCHMARK seguindo o código de referência ─────────────────────────────────── #
port = port_series(prices, WEIGHTS)
bench = bench / bench.iloc[0]  # rebased p/ métricas

# ── MÉTRICAS INDIVIDUAIS seguindo o código de referência ────────────────────────────────── #
metrics = {}
for tkr in WEIGHTS:
    if tkr in prices.columns:
        s = prices[tkr] / prices[tkr].iloc[0]
        metrics[tkr] = {"CAGR": cagr(s), "Vol": vol(prices[tkr]), "Max DD": max_dd(s)}

metrics["BENCH"] = {"CAGR": cagr(bench), "Vol": vol(bench), "Max DD": max_dd(bench)}
metrics["CARTEIRA"] = {"CAGR": cagr(port), "Vol": vol(port), "Max DD": max_dd(port)}

# ── CENÁRIOS DE STRESS seguindo o código de referência ──────────────────────────────────── #
stress_tbl = {n: scen_stats(port, *w) for n, w in STRESS.items()}

# ── PLOT (BASE 100 COMUM) seguindo o código de referência ───────────────────────────────── #
common = port.index.intersection(bench.index)
port100 = port.loc[common] / port.loc[common[0]] * 100
bench100 = bench.loc[common] / bench.loc[common[0]] * 100

fig, ax = plt.subplots(figsize=(16, 9))
fig.patch.set_facecolor('#ffffff')

# Linhas principais seguindo o código de referência
ax.plot(port100.index, port100.values, linewidth=3.5, color=PRIMARY_ORANGE, 
        alpha=0.9, label='Carteira Crédito', zorder=3)
ax.plot(bench100.index, bench100.values, linewidth=2.5, color=GRAY_ORANGE, 
        alpha=0.8, label='Benchmark HY (HYG)', zorder=2)

# Destacar períodos de stress seguindo o código de referência
stress_colors = [DARK_ORANGE, '#dc2626']
stress_alphas = [0.16, 0.16]

for i, (lbl, (ini, fim)) in enumerate(STRESS.items()):
    ini_ts, fim_ts = pd.Timestamp(ini), pd.Timestamp(fim)
    if ini_ts <= common[-1] and fim_ts >= common[0]:
        color_idx = i % len(stress_colors)
        ax.axvspan(max(ini_ts, common[0]), min(fim_ts, common[-1]),
                   alpha=stress_alphas[color_idx], color=stress_colors[color_idx], 
                   label=f'{lbl} window', edgecolor='none', zorder=1)

ax.set_ylabel('Índice (base 100)', fontsize=14, fontweight='600')
ax.set_xlabel('Período', fontsize=14, fontweight='600')

# Melhorar legenda
ax.legend(loc='upper left', frameon=True, fancybox=True, shadow=True, 
          fontsize=11, framealpha=0.95, edgecolor=GRAY_ORANGE)

# Grid e styling
ax.grid(True, alpha=0.3, linestyle='-', linewidth=0.8)
ax.set_axisbelow(True)

# Formatação de datas
ax.xaxis.set_major_formatter(mdates.DateFormatter('%Y'))
ax.xaxis.set_major_locator(mdates.YearLocator())
ax.xaxis.set_minor_locator(mdates.MonthLocator([1, 7]))

for spine in ax.spines.values():
    spine.set_color(GRAY_ORANGE)
    spine.set_linewidth(1.2)

chart_b64 = create_interactive_plot(fig)

# Calcular Sharpe seguindo o código de referência
sharpe = (metrics["CARTEIRA"]["CAGR"] - RF) / metrics["CARTEIRA"]["Vol"]

# Resultado final seguindo a estrutura do código de referência
result = {
    'data_source': 'API de Dados Financeiros Reais (Supabase)',
    'charts': {
        'performance': chart_b64
    },
    'metrics': metrics,
    'sharpe_ratio': float(sharpe),
    'stress_scenarios': stress_tbl,
    'period': f"{common[0].strftime('%Y-%m-%d')} até {common[-1].strftime('%Y-%m-%d')}",
    'total_days': int(len(port100)),
    'composition': WEIGHTS,
    'benchmark': BENCH_TKR,
    'available_tickers_sample': available_tickers[:10] if available_tickers else []
}

# Verificar se todos os valores são válidos e converter para float
import math
for asset, asset_metrics in result['metrics'].items():
    for metric, value in asset_metrics.items():
        if math.isnan(value) or math.isinf(value):
            result['metrics'][asset][metric] = 0.0
        else:
            result['metrics'][asset][metric] = float(value)

# Limpar dados de stress scenarios
for scenario, (dd, rec_days) in result['stress_scenarios'].items():
    if math.isnan(dd) or math.isinf(dd):
        dd = None
    else:
        dd = float(dd)
    if math.isnan(rec_days) or math.isinf(rec_days):
        rec_days = None
    else:
        rec_days = int(rec_days)
    result['stress_scenarios'][scenario] = (dd, rec_days)

# Verificar sharpe ratio
if math.isnan(result['sharpe_ratio']) or math.isinf(result['sharpe_ratio']):
    result['sharpe_ratio'] = 0.0

json.dumps(result)
`;

                // Executar Python
                const result = pyodide.runPython(pythonCode);
                
                // Validar e parsear resultado com tratamento de erro robusto
                let data;
                try {
                    data = JSON.parse(result);
                } catch (jsonError) {
                    console.error('Erro ao parsear JSON:', jsonError);
                    console.log('Resultado Python:', result.substring(0, 1000) + '...');
                    throw new Error(`Erro no processamento dos dados: ${jsonError.message}`);
                }
                
                // Mostrar resultados da análise seguindo o formato do código deimage.png referência
                outputDiv.innerHTML = `
                    <div class="space-y-6">
                     

                        <!-- Performance Principal -->
                        <div class="bg-white p-6 rounded-lg border border-orange-200 shadow-sm">
                            <h5 class="font-bold text-gray-800 mb-4 text-center text-lg">Carteira de Crédito vs. Benchmark HYG</h5>
                            <div class="text-center">
                                <img src="${data.charts.performance}" alt="Performance Chart" class="w-full max-w-5xl mx-auto rounded-lg shadow-md border border-gray-100">
                            </div>
                        </div>

                        <!-- Métricas de Desempenho seguindo o código de referência -->
                        <div class="bg-gradient-to-r from-orange-50 to-amber-50 p-6 rounded-lg border border-orange-200 shadow-sm">
                            <h5 class="font-bold text-orange-800 mb-6 text-center text-lg">Métricas de Performance</h5>
                            
                            <!-- Métricas Principais -->
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                                <div class="text-center bg-white p-4 rounded-lg border border-orange-100">
                                    <div class="text-2xl font-bold text-orange-900">${data.metrics.CARTEIRA.CAGR ? (data.metrics.CARTEIRA.CAGR * 100).toFixed(2) : '0.00'}%</div>
                                    <div class="text-sm text-orange-700 font-medium">CAGR</div>
                                </div>
                                <div class="text-center bg-white p-4 rounded-lg border border-orange-100">
                                    <div class="text-2xl font-bold text-orange-900">${data.metrics.CARTEIRA.Vol ? (data.metrics.CARTEIRA.Vol * 100).toFixed(2) : '0.00'}%</div>
                                    <div class="text-sm text-orange-700 font-medium">Volatilidade</div>
                                </div>
                                <div class="text-center bg-white p-4 rounded-lg border border-orange-100">
                                    <div class="text-2xl font-bold text-orange-900">${data.metrics.CARTEIRA['Max DD'] ? (data.metrics.CARTEIRA['Max DD'] * 100).toFixed(2) : '0.00'}%</div>
                                    <div class="text-sm text-orange-700 font-medium">Drawdown Máximo</div>
                                </div>
                            </div>

                            <!-- Métricas Comparativas -->
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div class="text-center bg-white p-4 rounded-lg border border-orange-100">
                                    <div class="text-xl font-bold text-orange-900">${data.sharpe_ratio ? data.sharpe_ratio.toFixed(2) : '0.00'}</div>
                                    <div class="text-sm text-orange-700 font-medium">Sharpe Ratio</div>
                                    <div class="text-xs text-gray-500 mt-1">Retorno por unidade de risco</div>
                                </div>
                                <div class="text-center bg-white p-4 rounded-lg border border-orange-100">
                                    <div class="text-xl font-bold text-orange-900">vs ${data.benchmark}</div>
                                    <div class="text-sm text-orange-700 font-medium">Benchmark</div>
                                    <div class="text-xs text-gray-500 mt-1">CAGR: ${data.metrics.BENCH.CAGR ? (data.metrics.BENCH.CAGR * 100).toFixed(2) : '0.00'}% | Vol: ${data.metrics.BENCH.Vol ? (data.metrics.BENCH.Vol * 100).toFixed(2) : '0.00'}%</div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                resultsDiv.classList.remove('hidden');
                
            } catch (error) {
                outputDiv.innerHTML = `
                    <div class="bg-red-50 p-6 rounded-lg border border-red-200">
                        <div class="flex items-start space-x-3">
                            <svg class="w-6 h-6 text-red-600 mt-1 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            <div>
                                <h5 class="font-bold text-red-800 mb-2">Erro na Análise de Manutenção</h5>
                                <p class="text-red-700 text-sm font-mono bg-red-100 p-3 rounded">${error.message}</p>
                            </div>
                        </div>
                    </div>
                `;
                resultsDiv.classList.remove('hidden');
            } finally {
                // Reset UI
                button.disabled = false;
                button.classList.remove('opacity-50');
                loadingDiv.classList.add('hidden');
            }
        });

        // Modal Functions
        function openModal(modalId) {
            document.getElementById(modalId).classList.remove('hidden');
            document.body.style.overflow = 'hidden'; // Prevent background scrolling
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.add('hidden');
            document.body.style.overflow = 'auto'; // Restore scrolling
        }

        // Close modal when clicking outside
        document.addEventListener('click', function(event) {
            if (event.target.classList.contains('fixed') && event.target.classList.contains('inset-0')) {
                const modals = ['soundpointModal', 'hildeneModal'];
                modals.forEach(modalId => {
                    if (!document.getElementById(modalId).classList.contains('hidden')) {
                        closeModal(modalId);
                    }
                });
            }
        });

        // Close modal with Escape key
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                const modals = ['soundpointModal', 'hildeneModal'];
                modals.forEach(modalId => {
                    if (!document.getElementById(modalId).classList.contains('hidden')) {
                        closeModal(modalId);
                    }
                });
            }
        });

        // Make modal functions globally available
        window.openModal = openModal;
        window.closeModal = closeModal;
    </script>

    <!-- Script Pyodide -->
    <script src="https://cdn.jsdelivr.net/pyodide/v0.24.1/full/pyodide.js"></script>
    <script>
        let pyodideInstance = null;

        async function initPyodide() {
            if (pyodideInstance) return pyodideInstance;
            
            pyodideInstance = await loadPyodide();
            
            // Instalar pacotes necessários
            await pyodideInstance.loadPackage(['numpy', 'pandas', 'matplotlib']);
            
            return pyodideInstance;
        }

        document.getElementById('runStressTest').addEventListener('click', async function() {
            const button = this;
            const loading = document.getElementById('pythonLoading');
            const results = document.getElementById('pythonResults');
            const output = document.getElementById('stressTestOutput');
            
            // UI feedback
            button.disabled = true;
            button.classList.add('opacity-50');
            loading.classList.remove('hidden');
            results.classList.add('hidden');
            
            try {
                // Inicializar Pyodide
                const pyodide = await initPyodide();
                
                // Código Python com dados reais - versão baseada no código de referência
                const pythonCode = `
import numpy as np
import pandas as pd
from datetime import datetime, timedelta
import matplotlib.pyplot as plt
import matplotlib.dates as mdates
from io import BytesIO
import base64
import js
import json

# Configurar matplotlib para gráficos interativos
plt.style.use('default')
plt.rcParams['figure.facecolor'] = '#ffffff'
plt.rcParams['axes.facecolor'] = '#fafafa'
plt.rcParams['axes.spines.top'] = False
plt.rcParams['axes.spines.right'] = False
plt.rcParams['axes.grid'] = True
plt.rcParams['grid.alpha'] = 0.3
plt.rcParams['grid.color'] = '#e5e7eb'
plt.rcParams['grid.linestyle'] = '-'
plt.rcParams['grid.linewidth'] = 0.8
plt.rcParams['font.family'] = 'sans-serif'
plt.rcParams['font.size'] = 11
plt.rcParams['axes.linewidth'] = 1.2
plt.rcParams['lines.linewidth'] = 2.5
plt.rcParams['axes.edgecolor'] = '#64748b'
plt.rcParams['axes.labelcolor'] = '#374151'
plt.rcParams['text.color'] = '#374151'
plt.rcParams['xtick.color'] = '#6b7280'
plt.rcParams['ytick.color'] = '#6b7280'

# Paleta de cores profissional
PRIMARY_BLUE = '#1e40af'
SECONDARY_BLUE = '#3b82f6'
ACCENT_BLUE = '#60a5fa'
DARK_BLUE = '#1e3a8a'
LIGHT_BLUE = '#93c5fd'
GRAY_BLUE = '#64748b'

# ── parâmetros seguindo o código de referência ─────────────────────────────────────────────── #
START_DATE = "2020-01-01"
WEIGHTS = {"BIL": 0.60, "IBTA.L": 0.20, "TFRN.L": 0.20}
BENCH_TKR = "SHY"
STRESS = {"COVID 2020": ("2020-02-19", "2020-03-23")}

def fetch_etf_data(symbol, base_url, api_key):
    """Busca dados reais via API"""
    url = f"{base_url}/rest/v1/json_data?id=eq.{symbol}"
    
    xhr_code = f"""
    (() => {{
        const xhr = new XMLHttpRequest();
        xhr.open('GET', '{url}', false);
        xhr.setRequestHeader('apikey', '{api_key}');
        xhr.setRequestHeader('Authorization', 'Bearer {api_key}');
        xhr.setRequestHeader('Content-Type', 'application/json');
        
        try {{
            xhr.send();
            return {{
                success: xhr.status >= 200 && xhr.status < 300,
                responseText: xhr.responseText
            }};
        }} catch (error) {{
            return {{ success: false, error: error.message }};
        }}
    }})()
    """
    
    result = js.eval(xhr_code)
    
    if not result.success:
        raise Exception(f"Erro ao buscar dados para {symbol}")
    
    data = json.loads(str(result.responseText))
    if not data or len(data) == 0:
        raise Exception(f"Dados não encontrados para {symbol}")
    
    raw_data = data[0]['data']
    
    # Extrair preços
    prices = {}
    for date_str, val in raw_data.items():
        try:
            if isinstance(val, dict):
                price = val.get('close', val.get('value', 0))
                if price == 0:
                    for k, v in val.items():
                        if isinstance(v, (int, float)) and v > 0:
                            price = v
                            break
            else:
                price = float(val)
            
            if price > 0:
                prices[date_str] = price
        except:
            continue
    
    if len(prices) < 50:
        raise Exception(f"Dados insuficientes para {symbol}")
    
    # Converter para Series
    price_series = pd.Series(prices)
    price_series.index = pd.to_datetime(price_series.index)
    price_series = price_series.sort_index()
    price_series = price_series[price_series > 0].dropna()
    
    return price_series

def portfolio_series(prices, w, rebalance=False):
    """Calcula série da carteira seguindo o código de referência"""
    returns = prices.pct_change().dropna()
    if rebalance:
        idx = prices/prices.iloc[0]
        return (idx * pd.Series(w)).sum(axis=1)
    port_ret = returns.mul(pd.Series(w), axis=1).sum(axis=1)
    return (1+port_ret).cumprod()

def scenario_metrics(series, start, end):
    """Calcula métricas de cenário seguindo o código de referência"""
    sub = series.loc[start:end]
    peak_before = series.loc[:start].max()
    dd = (sub/peak_before-1).min()
    # recuperação
    after = series.loc[end:]
    try:
        rec_day = after[after>=peak_before].index[0]
        rec_days = (rec_day - pd.to_datetime(end)).days
    except IndexError:
        rec_days = np.nan
    return dd, rec_days

def calc_cagr(series):
    """Calcula CAGR de uma série de preços"""
    years = (series.index[-1] - series.index[0]).days / 365.25
    return (series.iloc[-1] / series.iloc[0]) ** (1/years) - 1

def calc_volatility(series):
    """Calcula volatilidade anualizada"""
    returns = series.pct_change().dropna()
    return returns.std() * np.sqrt(252)

def calc_max_drawdown(series):
    """Calcula drawdown máximo"""
    cummax = series.expanding().max()
    drawdown = (series - cummax) / cummax
    return drawdown.min()

def create_interactive_plot(fig):
    """Converte plot para base64 com estilo profissional"""
    buffer = BytesIO()
    fig.savefig(buffer, format='png', dpi=150, bbox_inches='tight', 
                facecolor='white', edgecolor='none', pad_inches=0.2)
    buffer.seek(0)
    image_base64 = base64.b64encode(buffer.getvalue()).decode('utf-8')
    buffer.close()
    plt.close(fig)
    return f"data:image/png;base64,{image_base64}"

# Configuração da API
API_URL = "https://zpfjprlbvkvwvobijznt.supabase.co"
API_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpwZmpwcmxidmt2d3ZvYmlqem50Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDk2MDI5OTIsImV4cCI6MjA2NTE3ODk5Mn0.oK0k1cMerMUkvwLyggu-vJfdixPhZLvWW39MbQLFDyI"

print("Carregando dados históricos...")

# ── download seguindo o código de referência ───────────────────────────────────────────────── #
tickers = list(WEIGHTS.keys()) + [BENCH_TKR]
prices_data = {}

for symbol in tickers:
    try:
        print(f"Processando {symbol}...")
        prices_data[symbol] = fetch_etf_data(symbol, API_URL, API_KEY)
    except Exception as e:
        print(f"Erro {symbol}: {str(e)}")
        if symbol == BENCH_TKR:
            # Se não conseguir o benchmark, usar um dos ETFs como proxy
            print(f"Usando SGOV como proxy para {BENCH_TKR}")
            prices_data[symbol] = prices_data.get("SGOV", pd.Series())
        else:
            raise Exception(f"Dados indisponíveis para {symbol}")

# Criar DataFrame de preços
prices = pd.DataFrame(prices_data).ffill()

# Separar benchmark e carteira
bench = prices[BENCH_TKR].ffill()
portfolio_prices = prices[list(WEIGHTS.keys())]

# ── série da carteira seguindo o código de referência ─────────────────────────────────────── #
ret = portfolio_prices.pct_change().dropna()
port = (1 + (ret * pd.Series(WEIGHTS)).sum(axis=1)).cumprod()
bench = bench / bench.iloc[0]

# ── rebase para plot seguindo o código de referência ──────────────────────────────────────── #
common = port.index.intersection(bench.index)
port100 = port.loc[common] / port.loc[common[0]] * 100
bench100 = bench.loc[common] / bench.loc[common[0]] * 100

print(f"Dados processados: {len(port100)} observações")
print(f"Período: {common[0].strftime('%Y-%m-%d')} até {common[-1].strftime('%Y-%m-%d')}")

# GRÁFICO 1: Performance vs Benchmark seguindo o código de referência
fig1, ax1 = plt.subplots(figsize=(16, 9))
fig1.patch.set_facecolor('#ffffff')

# Linhas principais
ax1.plot(port100.index, port100.values, linewidth=3.5, color=PRIMARY_BLUE, 
         alpha=0.9, label='Carteira de Preservação', zorder=3)
ax1.plot(bench100.index, bench100.values, linewidth=2.5, color=GRAY_BLUE, 
         alpha=0.8, label='Benchmark 1-3Y (SHY)', zorder=2)

# Destacar períodos de stress
stress_colors = [DARK_BLUE]
stress_alphas = [0.15]

for i, (lbl, (ini, fim)) in enumerate(STRESS.items()):
    ini_ts, fim_ts = pd.Timestamp(ini), pd.Timestamp(fim)
    if ini_ts <= common[-1] and fim_ts >= common[0]:
        ax1.axvspan(max(ini_ts, common[0]), min(fim_ts, common[-1]),
                    alpha=stress_alphas[i], color=stress_colors[i], 
                    label=f'{lbl} window', edgecolor='none', zorder=1)
        
        # Calcular drawdown para o período
        period_mask = (port100.index >= ini_ts) & (port100.index <= fim_ts)
        if period_mask.any():
            period_data = port100[period_mask]
            pre_period = port100[port100.index < ini_ts]
            if len(pre_period) > 0:
                peak = pre_period.max()
                min_val = period_data.min()
                dd = (min_val / peak - 1) * 100
                
                mid_date = ini_ts + (fim_ts - ini_ts) / 2
                y_pos = period_data.mean()
                ax1.annotate(f'DD: {dd:.1f}%', 
                            xy=(mid_date, y_pos),
                            xytext=(0, 30), textcoords='offset points',
                            ha='center', fontsize=10, fontweight='bold',
                            color=DARK_BLUE, 
                            bbox=dict(boxstyle='round,pad=0.4', facecolor='white', 
                                     edgecolor=stress_colors[i], alpha=0.9, linewidth=1.5))

ax1.set_ylabel('Índice (base 100)', fontsize=14, fontweight='600')
ax1.set_xlabel('Período', fontsize=14, fontweight='600')

# Melhorar legenda
ax1.legend(loc='upper left', frameon=True, fancybox=True, shadow=True, 
           fontsize=11, framealpha=0.95, edgecolor=GRAY_BLUE)

# Grid e styling
ax1.grid(True, alpha=0.3, linestyle='-', linewidth=0.8)
ax1.set_axisbelow(True)

# Formatação de datas
ax1.xaxis.set_major_formatter(mdates.DateFormatter('%Y'))
ax1.xaxis.set_major_locator(mdates.YearLocator())
ax1.xaxis.set_minor_locator(mdates.MonthLocator([1, 7]))

for spine in ax1.spines.values():
    spine.set_color(GRAY_BLUE)
    spine.set_linewidth(1.2)

chart1_b64 = create_interactive_plot(fig1)

# Calcular métricas finais
portfolio_cagr = calc_cagr(port100)
portfolio_vol = calc_volatility(port100)
portfolio_dd = calc_max_drawdown(port100)
benchmark_cagr = calc_cagr(bench100)
benchmark_vol = calc_volatility(bench100)
benchmark_dd = calc_max_drawdown(bench100)

# Resultado final seguindo a estrutura
# Substituir SGOV por U03A na exibição
etfs_display = [ticker.replace('SGOV', 'U03A') for ticker in list(WEIGHTS.keys())]

result = {
    'data_source': 'API de Dados Financeiros',
    'charts': {
        'performance': chart1_b64
    },
    'stats': {
        'portfolio': {
            'cagr': round(portfolio_cagr * 100, 2),
            'volatility': round(portfolio_vol * 100, 2),
            'max_drawdown': round(portfolio_dd * 100, 2)
        },
        'benchmark': {
            'cagr': round(benchmark_cagr * 100, 2),
            'volatility': round(benchmark_vol * 100, 2),
            'max_drawdown': round(benchmark_dd * 100, 2)
        }
    },
    'period': f"{common[0].strftime('%Y-%m-%d')} até {common[-1].strftime('%Y-%m-%d')}",
    'total_days': len(port100),
    'etfs_included': etfs_display,
    'benchmark': BENCH_TKR
}

# Verificar se todos os valores são válidos
import math
for key, value in result['stats']['portfolio'].items():
    if math.isnan(value) or math.isinf(value):
        result['stats']['portfolio'][key] = 0.0

for key, value in result['stats']['benchmark'].items():
    if math.isnan(value) or math.isinf(value):
        result['stats']['benchmark'][key] = 0.0

json.dumps(result)
`;

                // Executar Python
                const result = pyodide.runPython(pythonCode);
                
                // Validar e parsear resultado com tratamento de erro robusto
                let data;
                try {
                    data = JSON.parse(result);
                } catch (jsonError) {
                    console.error('Erro ao parsear JSON:', jsonError);
                    console.log('Resultado Python:', result.substring(0, 1000) + '...');
                    throw new Error(`Erro no processamento dos dados: ${jsonError.message}`);
                }
                
                // Mostrar resultados da análise
                output.innerHTML = `
                    <div class="space-y-6">
                        

                        <!-- Performance Principal -->
                        <div class="bg-white p-6 rounded-lg border border-gray-200 shadow-sm">
                            <h5 class="font-bold text-gray-800 mb-4 text-center text-lg">Performance da Carteira de Preservação</h5>
                            <div class="text-center">
                                <img src="${data.charts.performance}" alt="Performance Chart" class="w-full max-w-5xl mx-auto rounded-lg shadow-md border border-gray-100">
                        </div>

                        </div>

                        <!-- Métricas de Performance -->
                        <div class="bg-gradient-to-r from-blue-50 to-slate-50 p-6 rounded-lg border border-blue-200 shadow-sm">
                            <h5 class="font-bold text-blue-800 mb-6 text-center text-lg">Métricas de Performance</h5>
                            
                            <!-- Métricas Principais -->
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                                <div class="text-center bg-white p-4 rounded-lg border border-blue-100">
                                    <div class="text-2xl font-bold text-blue-900">${data.stats.portfolio.cagr}%</div>
                                    <div class="text-sm text-blue-700 font-medium">CAGR</div>
                                </div>
                                <div class="text-center bg-white p-4 rounded-lg border border-blue-100">
                                    <div class="text-2xl font-bold text-blue-900">${data.stats.portfolio.volatility}%</div>
                                    <div class="text-sm text-blue-700 font-medium">Volatilidade</div>
                                </div>
                                <div class="text-center bg-white p-4 rounded-lg border border-blue-100">
                                    <div class="text-2xl font-bold text-blue-900">${data.stats.portfolio.max_drawdown}%</div>
                                    <div class="text-sm text-blue-700 font-medium">Drawdown Máximo</div>
                                </div>
                            </div>

                            <!-- Métricas Comparativas -->
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div class="text-center bg-white p-4 rounded-lg border border-blue-100">
                                    <div class="text-xl font-bold text-blue-900">${(data.stats.portfolio.cagr / data.stats.portfolio.volatility).toFixed(2)}</div>
                                    <div class="text-sm text-blue-700 font-medium">Sharpe Ratio</div>
                                    <div class="text-xs text-gray-500 mt-1">Retorno por unidade de risco</div>
                                </div>
                                <div class="text-center bg-white p-4 rounded-lg border border-blue-100">
                                    <div class="text-xl font-bold text-blue-900">vs ${data.benchmark}</div>
                                    <div class="text-sm text-blue-700 font-medium">Benchmark</div>
                                    <div class="text-xs text-gray-500 mt-1">CAGR: ${data.stats.benchmark.cagr}% | Vol: ${data.stats.benchmark.volatility}%</div>
                            </div>
                        </div>
                        </div>
                    </div>
                `;
                
                results.classList.remove('hidden');
                
            } catch (error) {
                output.innerHTML = `
                    <div class="bg-red-50 p-6 rounded-lg border border-red-200">
                        <div class="flex items-start space-x-3">
                            <svg class="w-6 h-6 text-red-600 mt-1 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            <div>
                                <h5 class="font-bold text-red-800 mb-2">Erro na Análise</h5>
                                <p class="text-red-700 text-sm font-mono bg-red-100 p-3 rounded">${error.message}</p>
                            </div>
                        </div>
                    </div>
                `;
                results.classList.remove('hidden');
            } finally {
                // Reset UI
                button.disabled = false;
                button.classList.remove('opacity-50');
                loading.classList.add('hidden');
            }
        });

        // Análise de Crescimento (VUAA)
        document.getElementById('runGrowthAnalysis')?.addEventListener('click', async function() {
            const button = this;
            const loadingDiv = document.getElementById('growthLoading');
            const resultsDiv = document.getElementById('growthResults');
            const outputDiv = document.getElementById('growthOutput');
            
            // UI feedback
            button.disabled = true;
            button.classList.add('opacity-50');
            loadingDiv.classList.remove('hidden');
            resultsDiv.classList.add('hidden');
            
            try {
                // Inicializar Pyodide
                const pyodide = await initPyodide();
                
                // Código Python usando dados REAIS da API Supabase
                const pythonCode = `
import numpy as np
import pandas as pd
from datetime import datetime, timedelta
import matplotlib.pyplot as plt
import matplotlib.dates as mdates
from io import BytesIO
import base64
import js
import json

# Configurar matplotlib para gráficos interativos
plt.style.use('default')
plt.rcParams['figure.facecolor'] = '#ffffff'
plt.rcParams['axes.facecolor'] = '#fafafa'
plt.rcParams['axes.spines.top'] = False
plt.rcParams['axes.spines.right'] = False
plt.rcParams['axes.grid'] = True
plt.rcParams['grid.alpha'] = 0.3
plt.rcParams['grid.color'] = '#e5e7eb'
plt.rcParams['grid.linestyle'] = '-'
plt.rcParams['grid.linewidth'] = 0.8
plt.rcParams['font.family'] = 'sans-serif'
plt.rcParams['font.size'] = 11
plt.rcParams['axes.linewidth'] = 1.2
plt.rcParams['lines.linewidth'] = 2.5
plt.rcParams['axes.edgecolor'] = '#64748b'
plt.rcParams['axes.labelcolor'] = '#374151'
plt.rcParams['text.color'] = '#374151'
plt.rcParams['xtick.color'] = '#6b7280'
plt.rcParams['ytick.color'] = '#6b7280'

# Paleta de cores vermelha para crescimento
PRIMARY_RED = '#dc2626'
SECONDARY_RED = '#ef4444'
ACCENT_RED = '#f87171'
DARK_RED = '#b91c1c'
LIGHT_RED = '#fca5a5'
GRAY_RED = '#78716c'

# ── PARÂMETROS ─────────────────────────────────────────────── #
START_DATE = "2019-01-12"
RF = 0.0  # Sharpe absoluto

WEIGHTS = {
    "VUAA.L": 1.00,  # VUAA 100%
}
BENCH_TKR = "^SP500TR"  # S&P 500 Total Return

STRESS = {
    "COVID 2020": ("2020-02-19", "2020-03-23"),
    "Election 24": ("2024-10-15", "2024-12-15"),
}

def fetch_etf_data_growth(symbol, base_url, api_key):
    """Busca dados reais via API Supabase para VUAA e S&P 500 TR"""
    # Primeiro, vamos listar os tickers disponíveis para debug
    try:
        list_url = f"{base_url}/rest/v1/json_data?select=id"
        list_xhr_code = f"""
        (() => {{
            const xhr = new XMLHttpRequest();
            xhr.open('GET', '{list_url}', false);
            xhr.setRequestHeader('apikey', '{api_key}');
            xhr.setRequestHeader('Authorization', 'Bearer {api_key}');
            xhr.setRequestHeader('Content-Type', 'application/json');
            
            try {{
                xhr.send();
                return {{
                    success: xhr.status >= 200 && xhr.status < 300,
                    responseText: xhr.responseText
                }};
            }} catch (error) {{
                return {{ success: false, error: error.message }};
            }}
        }})()
        """
        
        list_result = js.eval(list_xhr_code)
        if list_result.success:
            available_data = json.loads(str(list_result.responseText))
            available_tickers = [item['id'] for item in available_data]
            print(f"Tickers disponíveis na API: {len(available_tickers)} total")
            # Procurar por variações de VUAA ou S&P
            relevant_tickers = [t for t in available_tickers if 'VUAA' in t.upper() or 'S&P' in t.upper() or 'SP500' in t.upper() or 'SPY' in t.upper() or 'VOO' in t.upper()]
            if relevant_tickers:
                print(f"Tickers relevantes encontrados: {relevant_tickers[:10]}")
    except:
        pass
    
    # Mapeamento de tickers para a API
    ticker_map = {
        "VUAA.L": ["VUAA.L", "VUAA", "VUAA.LON", "VUSA.L", "VOO", "SPY"],
        "^SP500TR": ["^SP500TR", "SP500TR", "^GSPC", "SPY", "^SPX", "VOO"]
    }
    
    possible_tickers = ticker_map.get(symbol, [symbol])
    last_error = None
    
    for api_symbol in possible_tickers:
        try:
            url = f"{base_url}/rest/v1/json_data?id=eq.{api_symbol}"
            
            xhr_code = f"""
            (() => {{
                const xhr = new XMLHttpRequest();
                xhr.open('GET', '{url}', false);
                xhr.setRequestHeader('apikey', '{api_key}');
                xhr.setRequestHeader('Authorization', 'Bearer {api_key}');
                xhr.setRequestHeader('Content-Type', 'application/json');
                
                try {{
                    xhr.send();
                    return {{
                        success: xhr.status >= 200 && xhr.status < 300,
                        responseText: xhr.responseText,
                        status: xhr.status
                    }};
                }} catch (error) {{
                    return {{ success: false, error: error.message, status: 0 }};
                }}
            }})()
            """
            
            result = js.eval(xhr_code)
            
            if not result.success:
                last_error = f"HTTP {result.status} para {api_symbol}"
                continue
            
            data = json.loads(str(result.responseText))
            if not data or len(data) == 0:
                last_error = f"Dados vazios para {api_symbol}"
                continue
            
            raw_data = data[0]['data']
            
            # Extrair preços
            prices = {}
            for date_str, val in raw_data.items():
                try:
                    if isinstance(val, dict):
                        price = val.get('close', val.get('value', 0))
                        if price == 0:
                            for k, v in val.items():
                                if isinstance(v, (int, float)) and v > 0:
                                    price = v
                                    break
                    else:
                        price = float(val)
                    
                    if price > 0:
                        prices[date_str] = price
                except:
                    continue
            
            if len(prices) < 50:
                last_error = f"Dados insuficientes para {api_symbol} ({len(prices)} pontos)"
                continue
            
            # Sucesso!
            price_series = pd.Series(prices)
            price_series.index = pd.to_datetime(price_series.index)
            price_series = price_series.sort_index()
            price_series = price_series[price_series > 0].dropna()
            
            print(f"✓ Sucesso: {symbol} encontrado como {api_symbol} ({len(price_series)} pontos)")
            return price_series
            
        except Exception as e:
            last_error = f"Erro {api_symbol}: {str(e)}"
            continue
    
    # Se não conseguir dados reais
    raise Exception(f"Dados não encontrados para {symbol}. Tentativas: {possible_tickers}. Último erro: {last_error}")

def port_series(pr, w):
    """Calcula série temporal da carteira"""
    if isinstance(pr, pd.Series):
        return pr / pr.iloc[0]
    ret = pr.pct_change().dropna()
    return (1 + (ret * pd.Series(w)).sum(axis=1)).cumprod()

def cagr(s):
    """Retorno anualizado composto"""
    yrs = (s.index[-1] - s.index[0]).days / 365.25
    return (s.iloc[-1] / s.iloc[0]) ** (1/yrs) - 1

def vol(s):
    """Volatilidade anualizada"""
    return s.pct_change().std() * np.sqrt(252)

def max_dd(s):
    """Máximo drawdown"""
    return ((s / s.expanding().max()) - 1).min()

def scen_stats(s, ini, fim):
    """Estatísticas de cenário de stress"""
    ini_ts, fim_ts = pd.Timestamp(ini), pd.Timestamp(fim)
    if ini_ts not in s.index or fim_ts not in s.index:
        return np.nan, np.nan
    dd = (s.loc[ini_ts:fim_ts] / s.loc[:ini_ts].max() - 1).min()
    try:
        rec = s.loc[fim_ts:][s.loc[fim_ts:] >= s.loc[:ini_ts].max()].index[0]
        days = (rec - fim_ts).days
    except IndexError:
        days = np.nan
    return dd, days

def create_interactive_plot(fig):
    """Converte plot para base64"""
    buffer = BytesIO()
    fig.savefig(buffer, format='png', dpi=100, bbox_inches='tight', 
                facecolor='white', edgecolor='none', pad_inches=0.2)
    buffer.seek(0)
    image_base64 = base64.b64encode(buffer.getvalue()).decode('utf-8')
    buffer.close()
    plt.close(fig)
    return f"data:image/png;base64,{image_base64}"

# Configuração da API
API_URL = "https://zpfjprlbvkvwvobijznt.supabase.co"
API_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpwZmpwcmxidmt2d3ZvYmlqem50Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDk2MDI5OTIsImV4cCI6MjA2NTE3ODk5Mn0.oK0k1cMerMUkvwLyggu-vJfdixPhZLvWW39MbQLFDyI"

print("Carregando dados REAIS para análise de crescimento...")

# ── DOWNLOAD PREÇOS REAIS via API ─────────────────────────────────── #
etf_tickers = list(WEIGHTS.keys()) + [BENCH_TKR]
prices_data = {}

for symbol in etf_tickers:
    try:
        print(f"Processando {symbol}...")
        prices_data[symbol] = fetch_etf_data_growth(symbol, API_URL, API_KEY)
    except Exception as e:
        print(f"Erro {symbol}: {str(e)}")
        raise Exception(f"Dados indisponíveis para {symbol}")

# Criar DataFrame de preços
prices = pd.DataFrame(prices_data).ffill().dropna()

# Separar benchmark e carteira
bench = prices[BENCH_TKR]
portfolio_prices = prices[list(WEIGHTS.keys())]

# ── CARTEIRA E BENCHMARK seguindo o script fornecido ─────────────────────────────────────── #
port = port_series(portfolio_prices, WEIGHTS)
bench = bench / bench.iloc[0]  # rebased para métricas

# ── MÉTRICAS INDIVIDUAIS seguindo o script fornecido ────────────────────────────────────── #
metrics = {}

# Métricas do VUAA
for tkr in WEIGHTS:
    if tkr in prices.columns:
        s = prices[tkr] / prices[tkr].iloc[0]
        metrics[tkr] = {"CAGR": cagr(s), "Vol": vol(prices[tkr]), "Max DD": max_dd(s)}

# Métricas do benchmark e carteira
metrics["S&P500 TR"] = {"CAGR": cagr(bench), "Vol": vol(bench), "Max DD": max_dd(bench)}
metrics["CARTEIRA"] = {"CAGR": cagr(port), "Vol": vol(port), "Max DD": max_dd(port)}

# ── CENÁRIOS DE STRESS seguindo o script fornecido ──────────────────────────────────────── #
stress_tbl_cart = {n: scen_stats(port, *w) for n, w in STRESS.items()}
stress_tbl_bench = {n: scen_stats(bench, *w) for n, w in STRESS.items()}

# ── PLOT (BASE 100 COMUM) seguindo o script fornecido ───────────────────────────────────── #
common = port.index.intersection(bench.index)
port100 = port.loc[common] / port.loc[common[0]] * 100
bench100 = bench.loc[common] / bench.loc[common[0]] * 100

fig, ax = plt.subplots(figsize=(16, 9))
fig.patch.set_facecolor('#ffffff')

# Linhas principais
ax.plot(port100.index, port100.values, linewidth=3.5, color=PRIMARY_RED, 
        alpha=0.9, label='VUAA ETF', zorder=3)
ax.plot(bench100.index, bench100.values, linewidth=2.5, color=GRAY_RED, 
        alpha=0.8, label='S&P 500 TR', linestyle='--', zorder=2)

# Destacar períodos de stress
stress_colors = [DARK_RED, '#dc2626']
stress_alphas = [0.16, 0.16]

for i, (lbl, (ini, fim)) in enumerate(STRESS.items()):
    ini_ts, fim_ts = pd.Timestamp(ini), pd.Timestamp(fim)
    if ini_ts <= common[-1] and fim_ts >= common[0]:
        color_idx = i % len(stress_colors)
        ax.axvspan(max(ini_ts, common[0]), min(fim_ts, common[-1]),
                   alpha=stress_alphas[color_idx], color=stress_colors[color_idx], 
                   label=f'{lbl} window', edgecolor='none', zorder=1)

ax.set_ylabel('Índice (base 100)', fontsize=14, fontweight='600')
ax.set_xlabel('Período', fontsize=14, fontweight='600')

# Melhorar legenda
ax.legend(loc='upper left', frameon=True, fancybox=True, shadow=True, 
          fontsize=11, framealpha=0.95, edgecolor=GRAY_RED)

# Grid e styling
ax.grid(True, alpha=0.3, linestyle='-', linewidth=0.8)
ax.set_axisbelow(True)

# Formatação de datas
ax.xaxis.set_major_formatter(mdates.DateFormatter('%Y'))
ax.xaxis.set_major_locator(mdates.YearLocator())
ax.xaxis.set_minor_locator(mdates.MonthLocator([1, 7]))

for spine in ax.spines.values():
    spine.set_color(GRAY_RED)
    spine.set_linewidth(1.2)

chart_b64 = create_interactive_plot(fig)

# Calcular métricas adicionais seguindo o script fornecido
sharpe_cart = (metrics["CARTEIRA"]["CAGR"] - RF) / metrics["CARTEIRA"]["Vol"]
sharpe_bench = (metrics["S&P500 TR"]["CAGR"] - RF) / metrics["S&P500 TR"]["Vol"]

# Tracking Error e Information Ratio
ret_cart = port.pct_change().dropna()
ret_bench = bench.pct_change().dropna()
tracking_error = (ret_cart - ret_bench).std() * np.sqrt(252)
excess_return = metrics["CARTEIRA"]["CAGR"] - metrics["S&P500 TR"]["CAGR"]
info_ratio = excess_return / tracking_error if tracking_error > 0 else 0

# Correção e Beta
corr = ret_cart.corr(ret_bench)
cov_matrix = pd.concat([ret_cart, ret_bench], axis=1).cov()
beta = cov_matrix.iloc[0,1] / cov_matrix.iloc[1,1]

# Resultado final
result = {
    'data_source': 'API de Dados Financeiros Reais (Supabase)',
    'charts': {
        'performance': chart_b64
    },
    'metrics': metrics,
    'sharpe_ratios': {
        'vuaa': float(sharpe_cart),
        'sp500': float(sharpe_bench)
    },
    'tracking_metrics': {
        'tracking_error': float(tracking_error),
        'excess_return': float(excess_return),
        'information_ratio': float(info_ratio),
        'correlation': float(corr),
        'beta': float(beta)
    },
    'stress_scenarios': {
        'vuaa': stress_tbl_cart,
        'sp500': stress_tbl_bench
    },
    'period': f"{common[0].strftime('%Y-%m-%d')} até {common[-1].strftime('%Y-%m-%d')}",
    'total_days': int(len(port100)),
    'composition': WEIGHTS,
    'benchmark': BENCH_TKR
}

# Verificar se todos os valores são válidos
import math
for asset, asset_metrics in result['metrics'].items():
    for metric, value in asset_metrics.items():
        if math.isnan(value) or math.isinf(value):
            result['metrics'][asset][metric] = 0.0
        else:
            result['metrics'][asset][metric] = float(value)

# Limpar dados de stress scenarios
for scenario_dict in [result['stress_scenarios']['vuaa'], result['stress_scenarios']['sp500']]:
    for scenario, (dd, rec_days) in scenario_dict.items():
        if math.isnan(dd) or math.isinf(dd):
            dd = None
        else:
            dd = float(dd)
        if math.isnan(rec_days) or math.isinf(rec_days):
            rec_days = None
        else:
            rec_days = int(rec_days)
        scenario_dict[scenario] = (dd, rec_days)

json.dumps(result)
`;

                // Executar Python
                const result = pyodide.runPython(pythonCode);
                
                // Validar e parsear resultado
                let data;
                try {
                    data = JSON.parse(result);
                } catch (jsonError) {
                    console.error('Erro ao parsear JSON:', jsonError);
                    throw new Error(`Erro no processamento dos dados: ${jsonError.message}`);
                }
                
                // Mostrar resultados da análise
                outputDiv.innerHTML = `
                    <div class="space-y-6">
                        <!-- Performance Principal -->
                        <div class="bg-white p-6 rounded-lg border border-blue-200 shadow-sm">
                            <h5 class="font-bold text-gray-800 mb-4 text-center text-lg">VUAA ETF vs S&P 500 Total Return</h5>
                            <div class="text-center">
                                <img src="${data.charts.performance}" alt="Performance Chart" class="w-full max-w-5xl mx-auto rounded-lg shadow-md border border-gray-100">
                            </div>
                        </div>

                        <!-- Métricas de Desempenho -->
                        <div class="bg-gradient-to-r from-blue-50 to-slate-50 p-6 rounded-lg border border-blue-200 shadow-sm">
                            <h5 class="font-bold text-blue-800 mb-6 text-center text-lg">Métricas de Performance</h5>
                            
                            <!-- Métricas Principais -->
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                                <div class="text-center bg-white p-4 rounded-lg border border-blue-100">
                                    <div class="text-2xl font-bold text-blue-900">${data.metrics.CARTEIRA.CAGR ? (data.metrics.CARTEIRA.CAGR * 100).toFixed(2) : '0.00'}%</div>
                                    <div class="text-sm text-blue-700 font-medium">CAGR VUAA</div>
                                </div>
                                <div class="text-center bg-white p-4 rounded-lg border border-blue-100">
                                    <div class="text-2xl font-bold text-blue-900">${data.metrics.CARTEIRA.Vol ? (data.metrics.CARTEIRA.Vol * 100).toFixed(2) : '0.00'}%</div>
                                    <div class="text-sm text-blue-700 font-medium">Volatilidade</div>
                                </div>
                                <div class="text-center bg-white p-4 rounded-lg border border-blue-100">
                                    <div class="text-2xl font-bold text-blue-900">${data.sharpe_ratios.vuaa ? data.sharpe_ratios.vuaa.toFixed(2) : '0.00'}</div>
                                    <div class="text-sm text-blue-700 font-medium">Sharpe Ratio</div>
                                </div>
                            </div>

                            
                        </div>

                        
                    </div>
                `;
                
                resultsDiv.classList.remove('hidden');
                
            } catch (error) {
                outputDiv.innerHTML = `
                    <div class="bg-red-50 p-6 rounded-lg border border-red-200">
                        <div class="flex items-start space-x-3">
                            <svg class="w-6 h-6 text-red-600 mt-1 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            <div>
                                <h5 class="font-bold text-red-800 mb-2">Erro na Análise de Ganho</h5>
                                <p class="text-red-700 text-sm font-mono bg-red-100 p-3 rounded">${error.message}</p>
                            </div>
                        </div>
                    </div>
                `;
                resultsDiv.classList.remove('hidden');
            } finally {
                // Reset UI
                button.disabled = false;
                button.classList.remove('opacity-50');
                loadingDiv.classList.add('hidden');
            }
        });

        // Análise Final da Carteira Completa
        document.getElementById('runStressTestGlobal')?.addEventListener('click', async function() {
            const button = this;
            const loadingDiv = document.getElementById('pythonLoadingGlobal');
            const resultsDiv = document.getElementById('pythonResultsGlobal');
            const outputDiv = document.getElementById('stressTestOutputGlobal');
            
            // UI feedback
            button.disabled = true;
            button.classList.add('opacity-50');
            loadingDiv.classList.remove('hidden');
            resultsDiv.classList.add('hidden');
            
            try {
                // Inicializar Pyodide
                const pyodide = await initPyodide();
                
                // Código Python usando dados REAIS da API Supabase
                const pythonCode = `
import numpy as np
import pandas as pd
from datetime import datetime, timedelta
import matplotlib.pyplot as plt
import matplotlib.dates as mdates
from io import BytesIO
import base64
import js
import json

# Configurar matplotlib
plt.style.use('default')
plt.rcParams['figure.facecolor'] = '#ffffff'
plt.rcParams['axes.facecolor'] = '#fafafa'
plt.rcParams['axes.spines.top'] = False
plt.rcParams['axes.spines.right'] = False
plt.rcParams['axes.grid'] = True
plt.rcParams['grid.alpha'] = 0.3
plt.rcParams['grid.color'] = '#e5e7eb'
plt.rcParams['grid.linestyle'] = '-'
plt.rcParams['grid.linewidth'] = 0.8
plt.rcParams['font.family'] = 'sans-serif'
plt.rcParams['font.size'] = 11
plt.rcParams['axes.linewidth'] = 1.2
plt.rcParams['lines.linewidth'] = 2.5
plt.rcParams['axes.edgecolor'] = '#64748b'
plt.rcParams['axes.labelcolor'] = '#374151'
plt.rcParams['axes.titleweight'] = 'bold'
plt.rcParams['axes.titlesize'] = 14
plt.rcParams['axes.titlepad'] = 20
plt.rcParams['legend.frameon'] = True
plt.rcParams['legend.framealpha'] = 0.95
plt.rcParams['legend.edgecolor'] = '#e5e7eb'
plt.rcParams['legend.fontsize'] = 10

# Paleta de cores
PRIMARY_COLOR = '#1e3a8a'  # Azul escuro
SECONDARY_COLOR = '#dc2626'  # Vermelho
TERTIARY_COLOR = '#059669'  # Verde
GRAY_COLOR = '#6b7280'
LIGHT_GRAY = '#f3f4f6'

# Credenciais da API (mesmas da preservação)
api_key = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpwZmpwcmxidmt2d3ZvYmlqem50Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDk2MDI5OTIsImV4cCI6MjA2NTE3ODk5Mn0.oK0k1cMerMUkvwLyggu-vJfdixPhZLvWW39MbQLFDyI'
base_url = 'https://zpfjprlbvkvwvobijznt.supabase.co'

# Função para criar gráfico interativo
def create_interactive_plot(fig):
    buffer = BytesIO()
    plt.tight_layout()
    fig.savefig(buffer, format='png', dpi=150, bbox_inches='tight')
    buffer.seek(0)
    image_base64 = base64.b64encode(buffer.getvalue()).decode('utf-8')
    plt.close(fig)
    return f"data:image/png;base64,{image_base64}"

# Função para buscar dados via API (genérica)
def fetch_etf_data(symbol, base_url, api_key):
    """Busca dados reais via API Supabase"""
    url = f"{base_url}/rest/v1/json_data?id=eq.{symbol}"
    
    xhr_code = f"""
    (() => {{
        const xhr = new XMLHttpRequest();
        xhr.open('GET', '{url}', false);
        xhr.setRequestHeader('apikey', '{api_key}');
        xhr.setRequestHeader('Authorization', 'Bearer {api_key}');
        xhr.setRequestHeader('Content-Type', 'application/json');
        
        try {{
            xhr.send();
            return {{
                success: xhr.status >= 200 && xhr.status < 300,
                responseText: xhr.responseText
            }};
        }} catch (error) {{
            return {{ success: false, error: error.message }};
        }}
    }})()
    """
    
    result = js.eval(xhr_code)
    
    if not result.success:
        raise Exception(f"Erro ao buscar dados para {symbol}")
    
    data = json.loads(str(result.responseText))
    if not data or len(data) == 0:
        raise Exception(f"Dados não encontrados para {symbol}")
    
    raw_data = data[0]['data']
    
    # Extrair preços
    prices = {}
    for date_str, val in raw_data.items():
        try:
            if isinstance(val, dict):
                price = val.get('close', val.get('value', 0))
                if price == 0:
                    for k, v in val.items():
                        if isinstance(v, (int, float)) and v > 0:
                            price = v
                            break
            else:
                price = float(val)
            
            if price > 0:
                prices[date_str] = price
        except:
            continue
    
    if len(prices) < 50:
        raise Exception(f"Dados insuficientes para {symbol}")
    
    # Sucesso!
    price_series = pd.Series(prices)
    price_series.index = pd.to_datetime(price_series.index)
    price_series = price_series.sort_index()
    
    return price_series

# Parâmetros de análise
START_DATE = "2020-01-01"  # Começar antes da pandemia

# Composição da carteira com todos os 7 ativos
CARTEIRA = {
    # Camada de Preservação (20%)
    "BIL": 0.12,      # 60% de 20% = 12%
    "IBTA.L": 0.04,   # 20% de 20% = 4%
    "TFRN.L": 0.04,   # 20% de 20% = 4%
    
    # Camada de Manutenção (55%)
    "PIMCO": 0.33,    # 60% de 55% = 33%
    "TIP5.L": 0.11,   # 20% de 55% = 11%
    "SGLN.L": 0.11,   # 20% de 55% = 11%
    
    # Camada de Ganho (25%)
    "VUAA.L": 0.25    # 100% de 25% = 25%
}

# Benchmarks das 3 camadas
BENCHMARKS = ["BIL", "HYG", "^SP500TR"]

# Buscar dados de todos os ativos
print("Buscando dados dos ativos...")
portfolio_data = {}
for ticker, weight in CARTEIRA.items():
    try:
        data = fetch_etf_data(ticker, base_url, api_key)
        portfolio_data[ticker] = data
        # Debug: mostrar período de cada ativo
        print(f"✓ {ticker}: {len(data)} pontos, período: {data.index[0].strftime('%Y-%m-%d')} até {data.index[-1].strftime('%Y-%m-%d')}")
    except Exception as e:
        print(f"✗ {ticker}: {str(e)}")
        raise

# Função específica para buscar dados de growth (S&P 500 TR)
def fetch_etf_data_growth(symbol, base_url, api_key):
    """Busca dados reais via API Supabase para VUAA e S&P 500 TR"""
    # Mapeamento de tickers
    ticker_map = {
        "VUAA.L": ["VUAA.L", "VUAA", "VUAA.LON", "VUSA.L", "VOO", "SPY"],
        "^SP500TR": ["^SP500TR", "SP500TR", "^GSPC", "SPY", "^SPX", "VOO"]
    }
    
    possible_tickers = ticker_map.get(symbol, [symbol])
    
    for api_symbol in possible_tickers:
        try:
            url = f"{base_url}/rest/v1/json_data?id=eq.{api_symbol}"
            
            xhr_code = f"""
            (() => {{
                const xhr = new XMLHttpRequest();
                xhr.open('GET', '{url}', false);
                xhr.setRequestHeader('apikey', '{api_key}');
                xhr.setRequestHeader('Authorization', 'Bearer {api_key}');
                xhr.setRequestHeader('Content-Type', 'application/json');
                
                try {{
                    xhr.send();
                    return {{
                        success: xhr.status >= 200 && xhr.status < 300,
                        responseText: xhr.responseText
                    }};
                }} catch (error) {{
                    return {{ success: false, error: error.message }};
                }}
            }})()
            """
            
            result = js.eval(xhr_code)
            
            if not result.success:
                continue
            
            data = json.loads(str(result.responseText))
            if not data or len(data) == 0:
                continue
            
            raw_data = data[0]['data']
            
            # Extrair preços
            prices = {}
            for date_str, val in raw_data.items():
                try:
                    if isinstance(val, dict):
                        price = val.get('close', val.get('value', 0))
                        if price == 0:
                            for k, v in val.items():
                                if isinstance(v, (int, float)) and v > 0:
                                    price = v
                                    break
                    else:
                        price = float(val)
                    
                    if price > 0:
                        prices[date_str] = price
                except:
                    continue
            
            if len(prices) < 50:
                continue
            
            # Sucesso!
            price_series = pd.Series(prices)
            price_series.index = pd.to_datetime(price_series.index)
            price_series = price_series.sort_index()
            
            return price_series
            
        except Exception as e:
            continue
    
    raise Exception(f"Dados não encontrados para {symbol}")

# Buscar dados dos benchmarks
benchmark_data = {}
for ticker in BENCHMARKS:
    try:
        # Para S&P 500 TR, usar a função específica
        if ticker == "^SP500TR":
            data = fetch_etf_data_growth(ticker, base_url, api_key)
        else:
            data = fetch_etf_data(ticker, base_url, api_key)
        benchmark_data[ticker] = data
        print(f"✓ Benchmark {ticker}: {len(data)} pontos")
    except Exception as e:
        print(f"✗ Benchmark {ticker}: {str(e)}")
        # Usar ETFs correspondentes como fallback
        if ticker == "^SP500TR":
            data = portfolio_data.get("VUAA.L")
            if data is not None:
                benchmark_data[ticker] = data
                print(f"→ Usando VUAA.L como proxy para S&P 500 TR")
        elif ticker == "HYG":
            # Usar PIMCO como proxy para High Yield
            data = portfolio_data.get("PIMCO")
            if data is not None:
                benchmark_data[ticker] = data
                print(f"→ Usando PIMCO como proxy para HYG")

# Encontrar período comum
all_indices = []
for ticker, data in portfolio_data.items():
    all_indices.append(data.index)
    print(f"Debug - {ticker}: primeira data = {data.index[0]}, última data = {data.index[-1]}")

for ticker, data in benchmark_data.items():
    all_indices.append(data.index)
    print(f"Debug - Benchmark {ticker}: primeira data = {data.index[0]}, última data = {data.index[-1]}")

# Encontrar o período comum inicial
common_dates = all_indices[0]
print(f"Debug - Iniciando com {len(common_dates)} datas do primeiro ativo")
print(f"Debug - Primeira data: {common_dates[0]}, Última data: {common_dates[-1]}")

# Lista de tickers para debug
all_tickers = list(portfolio_data.keys()) + list(benchmark_data.keys())

for i, idx in enumerate(all_indices[1:]):
    before = len(common_dates)
    before_start = common_dates[0] if len(common_dates) > 0 else "N/A"
    common_dates = common_dates.intersection(idx)
    after = len(common_dates)
    after_start = common_dates[0] if len(common_dates) > 0 else "N/A"
    
    print(f"Debug - Após interseção com {all_tickers[i+1]}: {before} -> {after} datas")
    if before_start != after_start:
        print(f"        MUDOU data inicial de {before_start} para {after_start}")

print(f"Debug - Período comum ANTES do filtro: {common_dates[0]} até {common_dates[-1]}")

# Filtrar a partir da data de início definida
common_dates = common_dates[common_dates >= pd.Timestamp(START_DATE)]
print(f"Debug - Período comum APÓS filtro START_DATE: {common_dates[0]} até {common_dates[-1]}")

if len(common_dates) < 30:
    raise Exception(f"Período comum insuficiente: apenas {len(common_dates)} dias")

start_date = common_dates[0]
end_date = common_dates[-1]

print(f"\\nPeríodo de análise: {start_date.strftime('%Y-%m-%d')} até {end_date.strftime('%Y-%m-%d')}")
print(f"Total de dias: {len(common_dates)}")

# Debug: mostrar composição da carteira
print("\\nComposição da carteira:")
for ticker, weight in CARTEIRA.items():
    print(f"  {ticker}: {weight*100:.1f}%")

# Calcular retornos da carteira
portfolio_returns = pd.DataFrame()
for ticker, data in portfolio_data.items():
    # Normalizar os preços para calcular retornos
    prices = data.loc[common_dates]
    portfolio_returns[ticker] = prices.pct_change()

# Debug: verificar se há retornos extremos
print("Verificando retornos extremos por ativo:")
for ticker in portfolio_returns.columns:
    max_ret = portfolio_returns[ticker].max()
    min_ret = portfolio_returns[ticker].min()
    vol_anual = portfolio_returns[ticker].std() * np.sqrt(252)
    print(f"  {ticker}: Max={max_ret:.2%}, Min={min_ret:.2%}, Vol anual={vol_anual:.2%}")
    
    # Debug especial para BIL
    if ticker == "BIL" and (abs(max_ret) > 0.05 or vol_anual > 0.05):
        print(f"    ALERTA: BIL com volatilidade anormal!")
        # Mostrar alguns preços para debug
        prices = portfolio_data[ticker].loc[common_dates]
        print(f"    Primeiros 5 preços: {prices.iloc[:5].values}")
        print(f"    Últimos 5 preços: {prices.iloc[-5:].values}")

# Calcular série temporal da carteira - MÉTODO CORRETO
# Primeiro, criar DataFrame com preços normalizados
normalized_prices = pd.DataFrame()
for ticker, data in portfolio_data.items():
    prices = data.loc[common_dates]
    normalized_prices[ticker] = prices / prices.iloc[0] * 100  # Base 100

# Calcular a série da carteira ponderada
portfolio_series = pd.Series(0, index=common_dates)
for ticker, weight in CARTEIRA.items():
    portfolio_series += normalized_prices[ticker] * weight

# Debug: verificar valores
print(f"Valor inicial da carteira: {portfolio_series.iloc[0]:.2f}")
print(f"Valor final da carteira: {portfolio_series.iloc[-1]:.2f}")
print(f"Retorno total: {(portfolio_series.iloc[-1] / portfolio_series.iloc[0] - 1) * 100:.2f}%")

# Verificar drawdown máximo
max_value = portfolio_series.expanding().max()
drawdown = (portfolio_series - max_value) / max_value * 100
max_dd = drawdown.min()
print(f"Drawdown máximo da carteira: {max_dd:.2f}%")

# Calcular séries dos benchmarks (base 100)
benchmark_series = {}
for name, data in benchmark_data.items():
    series = data.loc[common_dates]
    benchmark_series[name] = (series / series.iloc[0]) * 100

# Criar gráfico principal
fig, ax = plt.subplots(figsize=(16, 10))
fig.patch.set_facecolor('#ffffff')

# Plot apenas da carteira final
ax.plot(portfolio_series.index, portfolio_series.values, 
        linewidth=3.5, color=PRIMARY_COLOR, alpha=0.9, 
        label='Carteira Avalon', zorder=5)

# Configurar eixos
ax.set_ylabel('Valor (Base 100)', fontsize=14, fontweight='600')
ax.set_xlabel('Período', fontsize=14, fontweight='600')
ax.set_title('Carteira Avalon - Performance Histórica', 
             fontsize=16, fontweight='bold', pad=20)

# Remover legenda pois só temos uma linha
ax.legend().set_visible(False)

# Grid e styling
ax.grid(True, alpha=0.3, linestyle='-', linewidth=0.8)
ax.set_axisbelow(True)

# Formatação de datas
years = mdates.YearLocator()
months = mdates.MonthLocator([1, 4, 7, 10])
years_fmt = mdates.DateFormatter('%Y')
ax.xaxis.set_major_locator(years)
ax.xaxis.set_major_formatter(years_fmt)
ax.xaxis.set_minor_locator(months)

# Estilo dos eixos
for spine in ax.spines.values():
    spine.set_color(GRAY_COLOR)
    spine.set_linewidth(1.2)

chart_b64 = create_interactive_plot(fig)

# Calcular métricas
def calculate_metrics(series, name):
    returns = series.pct_change().dropna()
    
    # CAGR
    years = (series.index[-1] - series.index[0]).days / 365.25
    cagr = (series.iloc[-1] / series.iloc[0]) ** (1/years) - 1
    
    # Volatilidade
    vol = returns.std() * np.sqrt(252)
    
    # Máximo Drawdown
    cummax = series.expanding().max()
    drawdown = (series - cummax) / cummax
    max_dd = drawdown.min()
    
    # Sharpe Ratio (assumindo RF = 2%)
    rf_rate = 0.02
    sharpe = (cagr - rf_rate) / vol if vol > 0 else 0
    
    return {
        "CAGR": cagr,
        "Volatilidade": vol,
        "Max Drawdown": max_dd,
        "Sharpe Ratio": sharpe,
        "Retorno Total": (series.iloc[-1] / series.iloc[0] - 1)
    }

# Calcular métricas para todos
metrics = {
    "Carteira": calculate_metrics(portfolio_series, "Carteira")
}

benchmark_names = {
    "BIL": "Preservação",
    "HYG": "Manutenção", 
    "^SP500TR": "Ganho"
}

for ticker, series in benchmark_series.items():
    name = benchmark_names.get(ticker, ticker)
    metrics[name] = calculate_metrics(series, name)

# Análise de correlação
returns_df = pd.DataFrame({
    "Carteira": portfolio_series.pct_change().dropna()
})

for ticker, series in benchmark_series.items():
    name = benchmark_names.get(ticker, ticker)
    returns_df[name] = series.pct_change().dropna()

correlation_matrix = returns_df.corr()

# Resultado final
result = {
    'data_source': 'API de Dados Financeiros Reais (Supabase)',
    'charts': {
        'performance': chart_b64
    },
    'metrics': metrics,
    'composition': CARTEIRA,
    'period': f"{start_date.strftime('%Y-%m-%d')} até {end_date.strftime('%Y-%m-%d')}",
    'total_days': len(common_dates),
    'correlation_matrix': correlation_matrix.to_dict()
}

json.dumps(result)
`;
                
                // Executar Python
                const result = pyodide.runPython(pythonCode);
                
                // Validar e parsear resultado
                let data;
                try {
                    data = JSON.parse(result);
                } catch (jsonError) {
                    console.error('Erro ao parsear JSON:', jsonError);
                    throw new Error(`Erro no processamento dos dados: ${jsonError.message}`);
                }
                
                // Mostrar resultados da análise
                outputDiv.innerHTML = `
                    <div class="space-y-6">
                        <!-- Performance Principal -->
                        <div class="bg-white p-6 rounded-lg border border-gray-200 shadow-sm">
                            <h5 class="font-bold text-gray-800 mb-4 text-center text-lg">Performance da Carteira Completa</h5>
                            <div class="text-center">
                                <img src="${data.charts.performance}" alt="Performance Chart" class="w-full max-w-6xl mx-auto rounded-lg shadow-md border border-gray-100">
                            </div>
                        </div>

                        <!-- Composição da Carteira -->
                        <div class="bg-gradient-to-r from-gray-50 to-blue-50 p-6 rounded-lg border border-gray-200 shadow-sm">
                            <h5 class="font-bold text-gray-800 mb-4 text-center text-lg">Composição da Carteira</h5>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                                <!-- Preservação -->
                                <div class="bg-white p-4 rounded-lg border border-blue-200">
                                    <h6 class="font-bold text-blue-800 mb-3">Preservação (20%)</h6>
                                    <ul class="space-y-2 text-sm">
                                        <li class="flex justify-between">
                                            <span>U03A:</span>
                                            <span class="font-bold">12%</span>
                                        </li>
                                        <li class="flex justify-between">
                                            <span>IBTA:</span>
                                            <span class="font-bold">4%</span>
                                        </li>
                                        <li class="flex justify-between">
                                            <span>TFRN:</span>
                                            <span class="font-bold">4%</span>
                                        </li>
                                    </ul>
                                </div>
                                
                                <!-- Manutenção -->
                                <div class="bg-white p-4 rounded-lg border border-orange-200">
                                    <h6 class="font-bold text-orange-800 mb-3">Manutenção (55%)</h6>
                                    <ul class="space-y-2 text-sm">
                                        <li class="flex justify-between">
                                            <span>PIMCO Income:</span>
                                            <span class="font-bold">33%</span>
                                        </li>
                                        <li class="flex justify-between">
                                            <span>TIP5:</span>
                                            <span class="font-bold">11%</span>
                                        </li>
                                        <li class="flex justify-between">
                                            <span>SGLN:</span>
                                            <span class="font-bold">11%</span>
                                        </li>
                                    </ul>
                                </div>
                                
                                <!-- Ganho -->
                                <div class="bg-white p-4 rounded-lg border border-pink-200">
                                    <h6 class="font-bold text-pink-800 mb-3">Ganho (25%)</h6>
                                    <ul class="space-y-2 text-sm">
                                        <li class="flex justify-between">
                                            <span>VUAA.L:</span>
                                            <span class="font-bold">25%</span>
                                        </li>
                                    </ul>
                                </div>
                            </div>
                        </div>

                        <!-- Métricas de Performance -->
                        <div class="bg-white p-6 rounded-lg border border-gray-200 shadow-sm">
                            <h5 class="font-bold text-gray-800 mb-6 text-center text-lg">Métricas Comparativas</h5>
                            
                            <div class="overflow-x-auto">
                                <table class="w-full text-sm">
                                    <thead>
                                        <tr class="border-b border-gray-200">
                                            <th class="text-left py-3 px-4 font-semibold text-gray-700">Métrica</th>
                                            <th class="text-right py-3 px-4 font-semibold text-gray-800">Carteira</th>
                                            <th class="text-right py-3 px-4 font-semibold text-blue-700">Preservação</th>
                                            <th class="text-right py-3 px-4 font-semibold text-orange-700">Manutenção</th>
                                            <th class="text-right py-3 px-4 font-semibold text-pink-700">Ganho</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr class="border-b border-gray-100">
                                            <td class="py-3 px-4 font-medium">CAGR</td>
                                            <td class="text-right py-3 px-4 font-bold text-gray-800">
                                                ${data.metrics.Carteira.CAGR ? (data.metrics.Carteira.CAGR * 100).toFixed(2) : '0.00'}%
                                            </td>
                                            <td class="text-right py-3 px-4 text-blue-700">
                                                ${data.metrics.Preservação?.CAGR ? (data.metrics.Preservação.CAGR * 100).toFixed(2) : '0.00'}%
                                            </td>
                                            <td class="text-right py-3 px-4 text-orange-700">
                                                ${data.metrics.Manutenção?.CAGR ? (data.metrics.Manutenção.CAGR * 100).toFixed(2) : '0.00'}%
                                            </td>
                                            <td class="text-right py-3 px-4 text-pink-700">
                                                ${data.metrics.Ganho?.CAGR ? (data.metrics.Ganho.CAGR * 100).toFixed(2) : '0.00'}%
                                            </td>
                                        </tr>
                                        <tr class="border-b border-gray-100">
                                            <td class="py-3 px-4 font-medium">Volatilidade</td>
                                            <td class="text-right py-3 px-4 font-bold text-gray-800">
                                                ${data.metrics.Carteira.Volatilidade ? (data.metrics.Carteira.Volatilidade * 100).toFixed(2) : '0.00'}%
                                            </td>
                                            <td class="text-right py-3 px-4 text-blue-700">
                                                ${data.metrics.Preservação?.Volatilidade ? (data.metrics.Preservação.Volatilidade * 100).toFixed(2) : '0.00'}%
                                            </td>
                                            <td class="text-right py-3 px-4 text-orange-700">
                                                ${data.metrics.Manutenção?.Volatilidade ? (data.metrics.Manutenção.Volatilidade * 100).toFixed(2) : '0.00'}%
                                            </td>
                                            <td class="text-right py-3 px-4 text-pink-700">
                                                ${data.metrics.Ganho?.Volatilidade ? (data.metrics.Ganho.Volatilidade * 100).toFixed(2) : '0.00'}%
                                            </td>
                                        </tr>
                                        <tr class="border-b border-gray-100">
                                            <td class="py-3 px-4 font-medium">Max Drawdown</td>
                                            <td class="text-right py-3 px-4 font-bold text-gray-800">
                                                ${data.metrics.Carteira['Max Drawdown'] ? (data.metrics.Carteira['Max Drawdown'] * 100).toFixed(2) : '0.00'}%
                                            </td>
                                            <td class="text-right py-3 px-4 text-blue-700">
                                                ${data.metrics.Preservação?.['Max Drawdown'] ? (data.metrics.Preservação['Max Drawdown'] * 100).toFixed(2) : '0.00'}%
                                            </td>
                                            <td class="text-right py-3 px-4 text-orange-700">
                                                ${data.metrics.Manutenção?.['Max Drawdown'] ? (data.metrics.Manutenção['Max Drawdown'] * 100).toFixed(2) : '0.00'}%
                                            </td>
                                            <td class="text-right py-3 px-4 text-pink-700">
                                                ${data.metrics.Ganho?.['Max Drawdown'] ? (data.metrics.Ganho['Max Drawdown'] * 100).toFixed(2) : '0.00'}%
                                            </td>
                                        </tr>
                                        <tr class="border-b border-gray-100">
                                            <td class="py-3 px-4 font-medium">Sharpe Ratio</td>
                                            <td class="text-right py-3 px-4 font-bold text-gray-800">
                                                ${data.metrics.Carteira['Sharpe Ratio'] ? data.metrics.Carteira['Sharpe Ratio'].toFixed(2) : '0.00'}
                                            </td>
                                            <td class="text-right py-3 px-4 text-blue-700">
                                                ${data.metrics.Preservação?.['Sharpe Ratio'] ? data.metrics.Preservação['Sharpe Ratio'].toFixed(2) : '0.00'}
                                            </td>
                                            <td class="text-right py-3 px-4 text-orange-700">
                                                ${data.metrics.Manutenção?.['Sharpe Ratio'] ? data.metrics.Manutenção['Sharpe Ratio'].toFixed(2) : '0.00'}
                                            </td>
                                            <td class="text-right py-3 px-4 text-pink-700">
                                                ${data.metrics.Ganho?.['Sharpe Ratio'] ? data.metrics.Ganho['Sharpe Ratio'].toFixed(2) : '0.00'}
                                            </td>
                                        </tr>
                                        <tr>
                                            <td class="py-3 px-4 font-medium">Retorno Total</td>
                                            <td class="text-right py-3 px-4 font-bold text-gray-800">
                                                ${data.metrics.Carteira['Retorno Total'] ? (data.metrics.Carteira['Retorno Total'] * 100).toFixed(2) : '0.00'}%
                                            </td>
                                            <td class="text-right py-3 px-4 text-blue-700">
                                                ${data.metrics.Preservação?.['Retorno Total'] ? (data.metrics.Preservação['Retorno Total'] * 100).toFixed(2) : '0.00'}%
                                            </td>
                                            <td class="text-right py-3 px-4 text-orange-700">
                                                ${data.metrics.Manutenção?.['Retorno Total'] ? (data.metrics.Manutenção['Retorno Total'] * 100).toFixed(2) : '0.00'}%
                                            </td>
                                            <td class="text-right py-3 px-4 text-pink-700">
                                                ${data.metrics.Ganho?.['Retorno Total'] ? (data.metrics.Ganho['Retorno Total'] * 100).toFixed(2) : '0.00'}%
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <div class="text-center text-sm text-gray-600 mt-4">
                            <p>Período de análise: ${data.period}</p>
                            <p>Total de dias analisados: ${data.total_days}</p>
                            <p>Fonte: ${data.data_source}</p>
                        </div>
                    </div>
                `;
                
                resultsDiv.classList.remove('hidden');
                
            } catch (error) {
                outputDiv.innerHTML = `
                    <div class="bg-red-50 p-6 rounded-lg border border-red-200">
                        <div class="flex items-start space-x-3">
                            <svg class="w-6 h-6 text-red-600 mt-1 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            <div>
                                <h5 class="font-bold text-red-800 mb-2">Erro na Análise Final</h5>
                                <p class="text-red-700 text-sm font-mono bg-red-100 p-3 rounded">${error.message}</p>
                            </div>
                        </div>
                    </div>
                `;
                resultsDiv.classList.remove('hidden');
            } finally {
                // Reset UI
                button.disabled = false;
                button.classList.remove('opacity-50');
                loadingDiv.classList.add('hidden');
            }
        });
    </script>

    <script>
        // Modal functionality
        function openModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.style.display = "block";
            }
        }

        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.style.display = "none";
            }
        }

        // When the page loads, set up modal event listeners
        window.addEventListener('DOMContentLoaded', function() {
            // Get the modal
            const modal = document.getElementById('operacionalModal');
            
            // Get the <span> element that closes the modal
            const span = modal.querySelector('.close');
            
            // When the user clicks on <span> (x), close the modal
            if (span) {
                span.onclick = function() {
                    modal.style.display = "none";
                }
            }
            
            // When the user clicks anywhere outside of the modal, close it
            window.onclick = function(event) {
                if (event.target == modal) {
                    modal.style.display = "none";
                }
            }
        });
    </script>

    <!-- Modal Operacional -->
    <style>
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        
        .modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 90%;
            max-width: 800px;
            border-radius: 8px;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        
        .close:hover,
        .close:focus {
            color: black;
        }
    </style>
    <div id="operacionalModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2 class="text-2xl font-bold mb-6">Roteiro Operacional</h2>


                <!-- Tabela de Passos -->
                <div class="mb-6">
                    <h4 class="text-base font-bold mb-3 text-gray-800">Passos de Execução</h4>
                    <div class="overflow-x-auto">
                        <table class="w-full border-collapse text-xs">
                            <thead>
                                <tr class="bg-gray-50">
                                    <th class="border border-gray-200 px-2 py-2 text-left font-semibold text-gray-700">#</th>
                                    <th class="border border-gray-200 px-2 py-2 text-left font-semibold text-gray-700">Vender</th>
                                    <th class="border border-gray-200 px-2 py-2 text-left font-semibold text-gray-700">Comprar</th>
                                    <th class="border border-gray-200 px-2 py-2 text-center font-semibold text-gray-700">%</th>
                                    <th class="border border-gray-200 px-2 py-2 text-left font-semibold text-gray-700">Custo</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Passo 1 -->
                                <tr class="hover:bg-gray-50">
                                    <td class="border border-gray-200 px-2 py-2 text-center font-bold">1</td>
                                    <td class="border border-gray-200 px-2 py-2">
                                        <strong>HY & EM</strong><br>
                                        <span class="text-gray-600">-13 pp</span>
                                    </td>
                                    <td class="border border-gray-200 px-2 py-2">
                                        <strong>PIMCO Income</strong>
                                    </td>
                                    <td class="border border-gray-200 px-2 py-2 text-center font-bold">13%</td>
                                    <td class="border border-gray-200 px-2 py-2">0,0-0,1%</td>
                                </tr>

                                <!-- Passo 2 -->
                                <tr class="hover:bg-gray-50">
                                    <td class="border border-gray-200 px-2 py-2 text-center font-bold">2</td>
                                    <td class="border border-gray-200 px-2 py-2">
                                        <strong>US Corp</strong><br>
                                        <span class="text-gray-600">-6 pp</span>
                                    </td>
                                    <td class="border border-gray-200 px-2 py-2">
                                        <strong>TIP5</strong>
                                    </td>
                                    <td class="border border-gray-200 px-2 py-2 text-center font-bold">6%</td>
                                    <td class="border border-gray-200 px-2 py-2"><0,03%</td>
                                </tr>

                                <!-- Passo 3 -->
                                <tr class="hover:bg-gray-50">
                                    <td class="border border-gray-200 px-2 py-2 text-center font-bold">3</td>
                                    <td class="border border-gray-200 px-2 py-2">
                                        <strong>Long T</strong><br>
                                        <span class="text-gray-600">-3 pp</span>
                                    </td>
                                    <td class="border border-gray-200 px-2 py-2">
                                        <strong>U03A</strong>
                                    </td>
                                    <td class="border border-gray-200 px-2 py-2 text-center font-bold">3%</td>
                                    <td class="border border-gray-200 px-2 py-2"><0,02%</td>
                                </tr>

                                <!-- Passo 4 -->
                                <tr class="hover:bg-gray-50">
                                    <td class="border border-gray-200 px-2 py-2 text-center font-bold">4</td>
                                    <td class="border border-gray-200 px-2 py-2">
                                        <strong>CLNs</strong><br>
                                        <span class="text-gray-600">-4 pp</span>
                                    </td>
                                    <td class="border border-gray-200 px-2 py-2">
                                        <strong>IBTA/TFRN</strong>
                                    </td>
                                    <td class="border border-gray-200 px-2 py-2 text-center font-bold">4%</td>
                                    <td class="border border-gray-200 px-2 py-2"><0,03%</td>
                                </tr>

                                <!-- Passo 5 -->
                                <tr class="hover:bg-gray-50">
                                    <td class="border border-gray-200 px-2 py-2 text-center font-bold">5</td>
                                    <td class="border border-gray-200 px-2 py-2">
                                        <strong>HF líq</strong><br>
                                        <span class="text-gray-600">-4 pp</span>
                                    </td>
                                    <td class="border border-gray-200 px-2 py-2">
                                        <strong>SGLN</strong>
                                    </td>
                                    <td class="border border-gray-200 px-2 py-2 text-center font-bold">4%</td>
                                    <td class="border border-gray-200 px-2 py-2"><0,04%</td>
                                </tr>

                                <!-- Passo 6 -->
                                <tr class="hover:bg-gray-50">
                                    <td class="border border-gray-200 px-2 py-2 text-center font-bold">6</td>
                                    <td class="border border-gray-200 px-2 py-2">
                                        <strong>Harris</strong><br>
                                        <span class="text-gray-600">-3 pp</span>
                                    </td>
                                    <td class="border border-gray-200 px-2 py-2">
                                        <strong>VUAA</strong>
                                    </td>
                                    <td class="border border-gray-200 px-2 py-2 text-center font-bold">3%</td>
                                    <td class="border border-gray-200 px-2 py-2"><0,02%</td>
                                </tr>

                                <!-- Passo 7 (Opcional) -->
                                <tr class="bg-gray-50">
                                    <td class="border border-gray-200 px-2 py-2 text-center text-gray-500">7</td>
                                    <td class="border border-gray-200 px-2 py-2">
                                        <span class="text-gray-500">HF/PE</span><br>
                                        <span class="text-gray-500 text-xs">-5 pp</span>
                                    </td>
                                    <td class="border border-gray-200 px-2 py-2">
                                        <span class="text-gray-500">CLO/Hildene</span>
                                    </td>
                                    <td class="border border-gray-200 px-2 py-2 text-center text-gray-500">5%</td>
                                    <td class="border border-gray-200 px-2 py-2 text-gray-500">0%</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <p class="text-xs text-gray-500 mt-2">
                        *ETFs UCITS - spreads mínimos
                    </p>
                </div>



                <!-- Checklist Operacional -->
                <div class="mb-6">
                    <h4 class="text-lg font-bold mb-4 text-gray-800">Checklist Operacional</h4>
                    <div class="overflow-x-auto">
                        <table class="min-w-full border-collapse">
                            <thead>
                                <tr class="bg-gray-50">
                                    <th class="border border-gray-200 px-4 py-3 text-left text-sm font-semibold text-gray-700">Item</th>
                                    <th class="border border-gray-200 px-4 py-3 text-left text-sm font-semibold text-gray-700">Responsável</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td class="border border-gray-200 px-4 py-3">Validar tamanhos-mínimos e ticket de U03A/IBTA/TFRN, TIP5, SGLN, VUAA</td>
                                    <td class="border border-gray-200 px-4 py-3">Mesa de operações</td>
                                </tr>
                                <tr>
                                    <td class="border border-gray-200 px-4 py-3">Confirmar gate/notice de resgate nos HY funds (AXA, Robeco etc.)</td>
                                    <td class="border border-gray-200 px-4 py-3">Middle-Office</td>
                                </tr>
                                <tr>
                                    <td class="border border-gray-200 px-4 py-3">Instrução de troca para PIMCO Income na mesma conta custódia</td>
                                    <td class="border border-gray-200 px-4 py-3">Portfolio Manager</td>
                                </tr>
                                <tr>
                                    <td class="border border-gray-200 px-4 py-3">Atualizar IPS / look-through risco-país pós-rebalance</td>
                                    <td class="border border-gray-200 px-4 py-3">Risk</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</body>
</html> 