#!/usr/bin/env python3
"""
Download de Releases de Resultados Trimestrais
==============================================
Script especializado para baixar apenas os releases de resultados trimestrais
das empresas listadas na CVM.
"""

from cvm_extractor_complete import CVMCompleteDocumentExtractor
from cvm_document_downloader import CVMDocumentDownloader
import json
import re
from datetime import datetime
from typing import List, Dict, Optional
import pandas as pd


class ReleasesTrimestralDownloader:
    """
    Classe especializada para download de releases de resultados trimestrais.
    """
    
    def __init__(self, pasta_destino: str = "releases_trimestrais"):
        self.extractor = CVMCompleteDocumentExtractor()
        self.downloader = CVMDocumentDownloader(pasta_destino)
        self.pasta_destino = pasta_destino
        
        # Padr√µes para identificar releases de resultados
        self.padroes_resultado = [
            r'resultado.*\d{1}t\d{2}',
            r'itr.*\d{1}t',
            r'release.*result',
            r'divulga√ß√£o.*resultado',
            r'earnings.*release',
            r'\d{1}t\d{2}.*resultado',
            r'resultado.*trimestre',
            r'resultado.*trimestral',
            r'desempenho.*\d{1}t\d{2}',
            r'demonstra√ß√µes.*\d{1}t\d{2}'
        ]
        
        # Palavras-chave adicionais
        self.palavras_chave = [
            'resultado', 'trimestre', 'itr', 'trimestral',
            '1t', '2t', '3t', '4t', 'release', 'earnings',
            'divulga√ß√£o', 'desempenho', 'demonstra√ß√µes'
        ]
    
    def identificar_release_resultado(self, documento: Dict) -> bool:
        """
        Identifica se um documento √© um release de resultado trimestral.
        """
        assunto = documento.get('assunto', '')
        if not assunto or not isinstance(assunto, str):
            return False
        
        assunto = assunto.lower()
        
        # Verificar padr√µes regex
        for padrao in self.padroes_resultado:
            if re.search(padrao, assunto):
                return True
        
        # Verificar combina√ß√µes de palavras-chave
        tem_resultado = any(palavra in assunto for palavra in ['resultado', 'result', 'earnings', 'desempenho'])
        tem_trimestre = any(palavra in assunto for palavra in ['1t', '2t', '3t', '4t', 'trimestre', 'trimestral', 'itr'])
        
        return tem_resultado and tem_trimestre
    
    def filtrar_releases_resultados(self, documentos: Dict) -> List[Dict]:
        """
        Filtra apenas os releases de resultados trimestrais.
        """
        releases_resultados = []
        
        # Verificar nos fatos relevantes
        for doc in documentos.get('fatos_relevantes', []):
            if self.identificar_release_resultado(doc):
                doc['origem'] = 'fato_relevante'
                releases_resultados.append(doc)
        
        # Verificar nos comunicados
        for doc in documentos.get('comunicados', []):
            if self.identificar_release_resultado(doc):
                doc['origem'] = 'comunicado'
                releases_resultados.append(doc)
        
        # Ordenar por data de entrega (mais recente primeiro)
        releases_resultados.sort(key=lambda x: x.get('data_entrega', ''), reverse=True)
        
        return releases_resultados
    
    def extrair_periodo_resultado(self, assunto: str) -> Optional[str]:
        """
        Extrai o per√≠odo do resultado (1T24, 2T24, etc) do assunto.
        """
        if not assunto or not isinstance(assunto, str):
            return None
            
        # Padr√µes para encontrar per√≠odos
        padroes_periodo = [
            r'(\d{1}t\d{2,4})',
            r'(\d{1}).*trimestre.*(\d{4})',
            r'trimestre.*(\d{4})'
        ]
        
        assunto_lower = assunto.lower()
        
        for padrao in padroes_periodo:
            match = re.search(padrao, assunto_lower)
            if match:
                return match.group(0)
        
        return None
    
    def baixar_releases_empresa(self, empresa: str, year: int = 2024, 
                               limite: Optional[int] = None) -> Dict:
        """
        Baixa os releases de resultados de uma empresa espec√≠fica.
        """
        print(f"\nüìä Processando releases de {empresa} - {year}")
        print("=" * 50)
        
        # Extrair todos os documentos
        print("üì• Extraindo metadados...")
        documentos = self.extractor.extract_company_documents(empresa, year)
        
        if not documentos:
            print(f"‚ùå Nenhum documento encontrado para {empresa}")
            return {'empresa': empresa, 'releases': [], 'downloads': {}}
        
        # Filtrar apenas releases de resultados
        releases = self.filtrar_releases_resultados(documentos)
        
        print(f"‚úÖ Encontrados {len(releases)} releases de resultados")
        
        if not releases:
            return {'empresa': empresa, 'releases': [], 'downloads': {}}
        
        # Mostrar releases encontrados
        print("\nüìã Releases identificados:")
        for i, release in enumerate(releases[:limite] if limite else releases):
            periodo = self.extrair_periodo_resultado(release['assunto']) or "N/A"
            print(f"   {i+1}. {release['data_entrega'][:10]} - {periodo}")
            print(f"      üìÑ {release['assunto'][:60]}...")
            print(f"      üìç Origem: {release['origem']}")
        
        # Preparar para download
        docs_para_download = {
            'releases_resultados': releases[:limite] if limite else releases
        }
        
        # Fazer download
        print(f"\nüíæ Baixando {len(docs_para_download['releases_resultados'])} releases...")
        resultado_download = self.downloader.download_company_documents(
            docs_para_download,
            empresa,
            tipos_documento=['releases_resultados']
        )
        
        return {
            'empresa': empresa,
            'releases': releases,
            'downloads': resultado_download
        }
    
    def baixar_multiplas_empresas(self, empresas: List[str], 
                                 year: int = 2024, 
                                 limite_por_empresa: int = 4) -> Dict:
        """
        Baixa releases de m√∫ltiplas empresas.
        """
        print("üè≠ DOWNLOAD DE RELEASES TRIMESTRAIS - M√öLTIPLAS EMPRESAS")
        print("=" * 60)
        
        resultados = {}
        total_downloads = 0
        total_erros = 0
        
        for i, empresa in enumerate(empresas, 1):
            print(f"\n[{i}/{len(empresas)}] Processando {empresa}")
            
            resultado = self.baixar_releases_empresa(empresa, year, limite_por_empresa)
            resultados[empresa] = resultado
            
            # Estat√≠sticas
            if resultado['downloads']:
                stats = resultado['downloads'].get('estatisticas', {})
                total_downloads += stats.get('downloads_sucesso', 0)
                total_erros += stats.get('downloads_erro', 0)
        
        # Resumo final
        print("\n" + "=" * 60)
        print("üìä RESUMO FINAL")
        print(f"   üè¢ Empresas processadas: {len(empresas)}")
        print(f"   ‚úÖ Downloads bem-sucedidos: {total_downloads}")
        print(f"   ‚ùå Downloads com erro: {total_erros}")
        
        return resultados
    
    def gerar_relatorio_releases(self, resultados: Dict, arquivo: str = None):
        """
        Gera relat√≥rio detalhado dos releases baixados.
        """
        if not arquivo:
            timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
            arquivo = f"relatorio_releases_{timestamp}.json"
        
        relatorio = {
            'data_geracao': datetime.now().isoformat(),
            'empresas_processadas': len(resultados),
            'total_releases_identificados': sum(len(r['releases']) for r in resultados.values()),
            'detalhes_por_empresa': {}
        }
        
        for empresa, dados in resultados.items():
            relatorio['detalhes_por_empresa'][empresa] = {
                'releases_encontrados': len(dados['releases']),
                'releases': [
                    {
                        'data': r['data_entrega'],
                        'assunto': r['assunto'],
                        'periodo': self.extrair_periodo_resultado(r['assunto']),
                        'origem': r['origem'],
                        'link': r['link_download']
                    }
                    for r in dados['releases']
                ]
            }
        
        with open(arquivo, 'w', encoding='utf-8') as f:
            json.dump(relatorio, f, ensure_ascii=False, indent=2)
        
        print(f"\nüìù Relat√≥rio salvo em: {arquivo}")
        return arquivo


def exemplo_uso_basico():
    """
    Exemplo b√°sico de uso do downloader de releases.
    """
    print("üéØ EXEMPLO: Download de Releases Trimestrais")
    print("=" * 45)
    
    # Criar inst√¢ncia do downloader
    downloader = ReleasesTrimestralDownloader("documents/releases_trimestrais")
    
    # Baixar releases de uma empresa
    empresa = "PETROBRAS"
    print(f"\nüìä Baixando releases de {empresa}...")
    
    resultado = downloader.baixar_releases_empresa(
        empresa=empresa,
        year=2024,
        limite=4  # √öltimos 4 releases (geralmente 1 ano)
    )
    
    # Gerar relat√≥rio
    downloader.gerar_relatorio_releases({empresa: resultado})
    
    return resultado


def exemplo_multiplas_empresas():
    """
    Exemplo com m√∫ltiplas empresas.
    """
    print("üè≠ EXEMPLO: M√∫ltiplas Empresas")
    print("=" * 35)
    
    # Lista de empresas
    empresas = ["VALE", "PETROBRAS", "ITAU", "AMBEV"]
    
    downloader = ReleasesTrimestralDownloader("documents/releases_trimestrais")
    
    # Baixar releases
    resultados = downloader.baixar_multiplas_empresas(
        empresas=empresas,
        year=2024,
        limite_por_empresa=2  # 2 √∫ltimos releases de cada
    )
    
    # Gerar relat√≥rio consolidado
    downloader.gerar_relatorio_releases(resultados)
    
    return resultados


def exemplo_analise_releases():
    """
    Exemplo de an√°lise de releases sem download.
    """
    print("üìä EXEMPLO: An√°lise de Releases (sem download)")
    print("=" * 45)
    
    downloader = ReleasesTrimestralDownloader()
    empresa = "B3"
    
    # Extrair documentos
    print(f"\nüîç Analisando releases de {empresa}...")
    documentos = downloader.extractor.extract_company_documents(empresa, 2024)
    
    if documentos:
        # Filtrar releases
        releases = downloader.filtrar_releases_resultados(documentos)
        
        print(f"\n‚úÖ Encontrados {len(releases)} releases de resultados")
        
        # Criar DataFrame para an√°lise
        if releases:
            df_releases = pd.DataFrame(releases)
            
            print("\nüìà An√°lise dos releases:")
            print(f"   Per√≠odo: {df_releases['data_entrega'].min()[:10]} a {df_releases['data_entrega'].max()[:10]}")
            print(f"   Origem: {df_releases['origem'].value_counts().to_dict()}")
            
            # Extrair per√≠odos
            df_releases['periodo'] = df_releases['assunto'].apply(
                downloader.extrair_periodo_resultado
            )
            
            print("\nüìÖ Per√≠odos identificados:")
            for _, row in df_releases.iterrows():
                print(f"   {row['data_entrega'][:10]} - {row['periodo'] or 'N/A'}")
                print(f"      {row['assunto'][:70]}...")
    
    return releases if 'releases' in locals() else []


def download_interativo():
    """
    Download interativo com escolha de empresa e per√≠odo.
    """
    print("üìä DOWNLOAD INTERATIVO DE RELEASES TRIMESTRAIS")
    print("=" * 50)
    
    # Escolher empresa
    empresa = input("\nüè¢ Digite o nome ou c√≥digo da empresa (ex: PETROBRAS, VALE, ITAU): ").strip().upper()
    if not empresa:
        print("‚ùå Nome da empresa √© obrigat√≥rio")
        return
    
    # Escolher ano
    ano_atual = datetime.now().year
    print(f"\nüìÖ Escolha o ano (Enter para {ano_atual}):")
    ano_str = input(f"   Ano [{ano_atual}]: ").strip()
    ano = int(ano_str) if ano_str.isdigit() else ano_atual
    
    # Escolher per√≠odo espec√≠fico
    print("\nüìÜ Escolha o per√≠odo:")
    print("   1. Ano completo (todos os trimestres)")
    print("   2. Trimestre espec√≠fico")
    print("   3. √öltimos N releases")
    
    opcao_periodo = input("üëâ Op√ß√£o (1-3): ").strip()
    
    trimestres_filtro = None
    limite = None
    
    if opcao_periodo == "2":
        print("\nüóìÔ∏è  Escolha o(s) trimestre(s):")
        print("   1. 1T (primeiro trimestre)")
        print("   2. 2T (segundo trimestre)")
        print("   3. 3T (terceiro trimestre)")
        print("   4. 4T (quarto trimestre)")
        print("   M√∫ltiplos: separe por v√≠rgula (ex: 1,3)")
        
        trimestres_input = input("üëâ Trimestre(s): ").strip()
        trimestres_selecionados = [f"{t.strip()}T" for t in trimestres_input.split(",") if t.strip()]
        trimestres_filtro = trimestres_selecionados
    
    elif opcao_periodo == "3":
        limite_str = input("üìä Quantos releases baixar? [4]: ").strip()
        limite = int(limite_str) if limite_str.isdigit() else 4
    
    # Criar downloader
    downloader = ReleasesTrimestralDownloader("documents/releases_trimestrais")
    
    # Processar
    print(f"\nüîç Buscando releases de {empresa} - {ano}")
    print("Por favor aguarde...")
    
    # Extrair documentos
    documentos = downloader.extractor.extract_company_documents(empresa, ano)
    
    if not documentos:
        print(f"‚ùå Nenhum documento encontrado para {empresa}")
        return
    
    # Filtrar releases
    releases = downloader.filtrar_releases_resultados(documentos)
    
    if not releases:
        print(f"‚ùå Nenhum release de resultado encontrado para {empresa} em {ano}")
        return
    
    # Aplicar filtro de trimestres se especificado
    if trimestres_filtro:
        releases_filtrados = []
        for release in releases:
            assunto_lower = release['assunto'].lower()
            for trimestre in trimestres_filtro:
                if trimestre.lower() in assunto_lower:
                    releases_filtrados.append(release)
                    break
        releases = releases_filtrados
    
    # Aplicar limite se especificado
    if limite:
        releases = releases[:limite]
    
    print(f"\n‚úÖ Encontrados {len(releases)} releases para download")
    
    if not releases:
        print("‚ùå Nenhum release corresponde aos crit√©rios selecionados")
        return
    
    # Mostrar releases que ser√£o baixados
    print("\nüìã Releases a serem baixados:")
    for i, release in enumerate(releases, 1):
        periodo = downloader.extrair_periodo_resultado(release['assunto']) or "N/A"
        print(f"   {i}. {release['data_entrega'][:10]} - {periodo}")
        print(f"      üìÑ {release['assunto'][:60]}...")
    
    # Confirmar download
    confirma = input("\nüíæ Confirma o download? (S/n): ").strip().lower()
    if confirma == 'n':
        print("‚ùå Download cancelado")
        return
    
    # Preparar para download
    docs_para_download = {'releases_resultados': releases}
    
    # Fazer download
    print(f"\nüíæ Baixando {len(releases)} releases...")
    resultado_download = downloader.downloader.download_company_documents(
        docs_para_download,
        empresa,
        tipos_documento=['releases_resultados']
    )
    
    # Estat√≠sticas
    if resultado_download:
        stats = resultado_download.get('estatisticas', {})
        print(f"\n‚úÖ Downloads conclu√≠dos:")
        print(f"   üì• Sucesso: {stats.get('downloads_sucesso', 0)}")
        print(f"   ‚ùå Erros: {stats.get('downloads_erro', 0)}")
        print(f"   üìÅ J√° existentes: {stats.get('arquivos_existentes', 0)}")
    
    # Gerar relat√≥rio
    timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
    relatorio_arquivo = f"relatorio_{empresa}_{timestamp}.json"
    downloader.gerar_relatorio_releases({empresa: {'releases': releases, 'downloads': resultado_download}}, relatorio_arquivo)
    
    print(f"\nüìÅ Arquivos salvos em: documents/releases_trimestrais/{empresa}/")
    
    return resultado_download


def main():
    """
    Menu principal.
    """
    print("üìä SISTEMA DE DOWNLOAD DE RELEASES TRIMESTRAIS")
    print("=" * 50)
    print("\nEscolha uma op√ß√£o:")
    print("1. üì• Download interativo (escolha empresa e per√≠odo)")
    print("2. üìä Apenas an√°lise (sem download)")
    print("3. ‚ùå Sair")
    
    opcao = input("\nüëâ Escolha (1-3): ").strip()
    
    if opcao == "1":
        download_interativo()
    elif opcao == "2":
        exemplo_analise_releases()
    elif opcao == "3":
        print("üëã At√© logo!")
    else:
        print("‚ùå Op√ß√£o inv√°lida")


if __name__ == "__main__":
    main()